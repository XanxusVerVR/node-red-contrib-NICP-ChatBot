<script type="text/javascript">
	RED.nodes.registerType("lower-case", {
		category: "input",
		color: "#BBFF66",
		defaults: {
			name: {
				value: ""
			},
			name2: {
				value: ""
			},
			datas: {
				value: [{
					a: "str",
					b: "Xanxus"
				}]
			}
		},
		inputs: 1,
		outputs: 1,
		paletteLabel: "lower-case",
		icon: "file.png",
		label: function () {
			let labelName = "Lower Case";
			if (this.name) {
				return `${labelName} : ${this.name}`;
			}
			else {
				return labelName;
			}
		},

		oneditprepare: function () {
			// this.type是這個節點的類型，如：lower-case。為字串

			let showContextList = function () {
				$.when(
					$.getJSON(`context/flow/${this.z}`)
				).then((data1) => {
					// console.log(JSON.parse(data1.xanxusContext[this.type].msg)[1].name2);
					this.name2 = JSON.parse(data1.xanxusContext[this.type].msg)[1].name2;
					this.datas = JSON.parse(data1.xanxusContext[this.type].msg)[1].datas;
					$("#node-input-name2").val(this.name2);
					// console.log(this.name2);
					for (let i = 0; i < this.datas.length; i++) {
						let data = this.datas[i];
						$("#node-input-rule-container").editableList("addItem", data);
					}
				}).fail(function (problem) {
					console.log(problem);
				});
			}.bind(this);

			showContextList();

			// $("#node-input-name2").prop('disabled', false);

			$("#node-input-rule-container").css("min-height", "300px").css("min-width", "450px").editableList({
				addItem: function (container, i, data) {
					if (!data.hasOwnProperty("a")) {
						data.a = "str";
						data.b = "Xanxus";
					}
					let propertyValue = $("<input/>", { class: "node-input-xanxusInput", type: "text", value: data.a })
						.appendTo(container);
					let propertyValue2 = $("<input/>", { class: "node-input-xanxusInput2", type: "text", value: data.b })
						.appendTo(container);
					propertyValue.val(data.a);
					propertyValue2.val(data.b);
				},
				removable: true,
				sortable: true
			})

			// for (let i = 0; i < this.datas.length; i++) {
			// 	let data = this.datas[i];
			// 	$("#node-input-rule-container").editableList("addItem", data);
			// }

		},
		oneditsave: function () {
			let datas = $("#node-input-rule-container").editableList("items");//這是在取得html dom相關的物件
			let node = this;// 取得這個節點的相關屬性
			node.datas = [];
			datas.each(function (i) {//走訪DOM中的每個item物件
				let data = $(this);//取得這次這個DOM item物件
				// 從DOM item物件中找到元素的值
				let r = {
					a: data.find(".node-input-xanxusInput").val(),
					b: data.find(".node-input-xanxusInput2").val()
				};
				node.datas.push(r);//放進去
			});
			node.name2 = $("#node-input-name2").val();
			// $("#node-input-name2").val(this.name2);
			// let showContextList = function () {
			// 	$.when(
			// 		$.getJSON(`context/flow/${this.z}`)
			// 	).then((data1) => {
			// 		console.log(JSON.parse(data1.xanxusContext[this.type].msg)[1].name2);
			// 		this.name2 = JSON.parse(data1.xanxusContext[this.type].msg)[1].name2;
			// 		this.datas = JSON.parse(data1.xanxusContext[this.type].msg)[1].datas;
			// 		$("#node-input-name2").val(this.name2);
			// 		// console.log(this.name2);
			// 		for (let i = 0; i < this.datas.length; i++) {
			// 			let data = this.datas[i];
			// 			$("#node-input-rule-container").editableList("addItem", data);
			// 		}
			// 	}).fail(function (problem) {
			// 		console.log(problem);
			// 	});
			// }.bind(this);

			// showContextList();
			// console.log(node);
		}
	});
</script>

<!-- 定義此節點的表單元件 -->
<script type="text/x-red" data-template-name="lower-case">
	<!-- 節點名稱 -->
	<div class="form-row">
		<label for="node-input-name"><i class="icon-tag"></i> Name</label>
		<input type="text" id="node-input-name" placeholder="Name">
	</div>

	<!-- 節點名稱2:測試用 -->
	<div class="form-row">
		<label for="node-input-name2"><i class="icon-tag"></i> Name2</label>
		<input type="text" id="node-input-name2" placeholder="Name2">
    </div>

	<!-- 定義裝表單項目的容器? -->
	<div class="form-row node-input-rule-container-row">
		<ol id="node-input-rule-container"></ol>
	</div>
</script>

<!-- 定義節點的右邊資訊欄的輔助說明文字 -->
<script type="text/x-red" data-help-name="lower-case">
	<p>A simple node that converts the message payloads into all lower-case characters</p>
</script>