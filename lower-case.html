<script type="text/javascript">
	RED.nodes.registerType("lower-case", {
		color: "#FFCCCC",
		category: "input",
		defaults: {
			name: {
				value: ""
			},
			format: {
				value: "handlebars"
			},
			template: {
				value: "This is the payload: {{payload}} !"
			},
			message: {
                value: [""]
            }
		},
		inputs: 1,
		outputs: 1,
		icon: "template.png",
		label: function () {
			return "lower case node";
		},
		oneditprepare: function () {

			let node = this;

			this.editor = RED.editor.createEditor({
				id: "node-input-template-editor",
				mode: "ace/mode/html",
				value: $("#node-input-template").val()//印出This is the payload: {{payload}} !
			});

			// 少了這個就沒有高亮度了
			$("#node-input-format").change(function () {
				let mod = "ace/mode/" + $("#node-input-format").val();
				node.editor.getSession().setMode({
					path: mod,
					v: Date.now()
				});
			});
		},
		oneditsave: function () {
			$("#node-input-template").val(this.editor.getValue());
			this.editor.destroy();
			delete this.editor;
		},
		oneditcancel: function () {
			this.editor.destroy();
			delete this.editor;
		},
		oneditresize: function (size) {
			let rows = $("#dialog-form>div:not(.node-text-editor-row)");
			let height = $("#dialog-form").height();
			for (let i = 0; i < rows.size(); i++) {
				height -= $(rows[i]).outerHeight(true);
			}
			let editorRow = $("#dialog-form>div.node-text-editor-row");
			height -= (parseInt(editorRow.css("marginTop")) + parseInt(editorRow.css("marginBottom")));
			$(".node-text-editor").css("height", height + "px");
			this.editor.resize();
		}
	});
</script>

<!-- 定義此節點的表單元件 -->
<script type="text/x-red" data-template-name="lower-case">

    <div class="form-row" style="position: relative; margin-bottom: 0px;">
        <label for="node-input-template"><i class="fa fa-file-code-o"></i> <span data-i18n="template.label.template"></span></label>
        <input type="hidden" id="node-input-template" autofocus="autofocus">
        <div style="position: absolute; right:0;display:inline-block; text-align: right; font-size: 0.8em;">
            <span data-i18n="template.label.format"></span>:
            <select id="node-input-format" style="width:110px; font-size: 10px !important;  height: 24px; padding:0;">
                <option value="handlebars">mustache</option>
                <option value="html">HTML</option>
                <option value="json">JSON</option>
                <option value="javascript">Javascript</option>
                <option value="css">CSS</option>
                <option value="markdown">Markdown</option>
                <option value="yaml">YAML</option>
                <option value="text" data-i18n="template.label.none"></option>
            </select>
        </div>
    </div>
    <div class="form-row node-text-editor-row">
        <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-template-editor" ></div>
    </div>

</script>

<!-- 定義節點的右邊資訊欄的輔助說明文字 -->
<script type="text/x-red" data-help-name="lower-case">
	<p>A simple node that converts the message payloads into all lower-case characters</p>
</script>