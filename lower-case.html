<script type="text/javascript">
	RED.nodes.registerType("lower-case", {
		//定義此節點要在NodeRED編輯器左邊的哪個分類之中，所以這裡定義他要在function分類中
		category: "function",
		color: "#a6bbcf",
		//定義預設值，當拉出節點時會顯示設值
		defaults: {
			// 節點於編輯器右邊資訊欄Name欄位所顯示的字串
			name: {
				value: ""
			},
			name2: {
				value: ""
			},
			myCredentials: {
				value: "",
				type: "config-credential-node",
				required: true
			}
		},
		//一開始是幾個輸入
		inputs: 1,
		//一開始是幾個輸出
		outputs: 1,
		icon: "file.png",
		//定義節點拉出來的時候，預設顯示的字串
		label: function () {
			return this.name || "lower case";
		},
		// 定義節點在左邊時的字串(還沒拉出來的時候)
		paletteLabel: "Lower Case",
		// 定義在編輯表單開啟時，要做的事
		oneditprepare: function () {
			function getContextKeys(data) {
				let sortedData = {};
				for (let store in data) {
					if (data.hasOwnProperty(store)) {
						for (let key in data[store]) {
							if (data[store].hasOwnProperty(key)) {
								if (!sortedData.hasOwnProperty(key)) {
									sortedData[key] = [];
								}
								data[store][key].store = store;
								sortedData[key].push(data[store][key])
							}
						}
					}
				}
				let keys = Object.keys(sortedData);
				keys.sort();
				return keys;
			}
			$.when(
				$.getJSON(`context/flow/${this.z}`),
				$.getJSON(`context/global`)
				/*
				data1(Array):
					0: {memory: {…}}
					1: "success"
					2:
						abort: ƒ (a)
						always: ƒ ()
						complete: ƒ ()
						done: ƒ ()
						error: ƒ ()
						fail: ƒ ()
						getAllResponseHeaders: ƒ ()
						getResponseHeader: ƒ (a)
						overrideMimeType: ƒ (a)
						pipe: ƒ ()
						progress: ƒ ()
						promise: ƒ (a)
						readyState: 4
						responseJSON: {memory: {…}}
						responseText: "{"memory":{"aaa":{"msg":"123","format":"string[3]"}}}"
						setRequestHeader: ƒ (a,b)
						state: ƒ ()
						status: 200
						statusCode: ƒ (a)
						statusText: "OK"
						success: ƒ ()
						then: ƒ ()
				*/
			).then(function (data1, data2) {
				console.log(getContextKeys(data1[0]));
				console.log(getContextKeys(data2[0]));
			}).fail(function (problem) {
				console.log(problem);
			});

			$("#node-input-rule-container").css("min-height", "300px").css("min-width", "450px").editableList({
				addItem: function (container, i, opt) {
					let row2 = $("<div/>", { style: "margin-top:8px;" }).appendTo(container);
					$("<div/>", { style: "display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;" })
						.text(to)
						.appendTo(row2);
				}
			})
		},
		// 定義將編輯表單儲存時，要做的事
		oneditsave: function () {
		}
	});
</script>

<!-- 定義此節點的表單元件 -->
<script type="text/x-red" data-template-name="lower-case">
	<div class="form-row">
		<label for="node-input-name"><i class="icon-tag"></i> Name</label>
		<input type="text" id="node-input-name" placeholder="Name">
	</div>
	<!-- 自定義的name2表單，用來當作測試時新定義的屬性 -->
	<div class="form-row">
		<label for="node-input-name2"><i class="icon-tag"></i> Name2 Xanxus Xanxus</label>
		<input type="text" id="node-input-name2" placeholder="Name2">
	</div>
	<!-- 這裡要放置一個input表單來當設置Credentials資料的進入點 -->
	<div class="form-row">
        <label for="node-input-myCredentials" style="width:100%;"><i class="icon-bookmark"></i>My Credentials</label>
        <input type="text" id="node-input-myCredentials">
    </div>
	<div class="form-row" style="margin-bottom:0;">
		<label><i class="fa fa-list"></i> <span data-i18n="change.label.rules"></   ></label>
	</div>
	<div class="form-row node-input-rule-container-row">
		<ol id="node-input-rule-container"></ol>
	</div>
</script>

<!-- 定義節點的右邊資訊欄的輔助說明文字 -->
<script type="text/x-red" data-help-name="lower-case">
	<p>A simple node that converts the message payloads into all lower-case characters</p>
</script>