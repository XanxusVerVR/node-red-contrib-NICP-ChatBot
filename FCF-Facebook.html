<script type="text/javascript">//FCF-facebook-node開始
    RED.nodes.registerType("FCF-facebook-node", {//FCF-facebook-node表示整個Facebook Node，包含Facebook In Facebook Out
        category: "config",//定義成config不會出現在面板左邊
        defaults: {
            botname: {
                value: "",
                required: true//表示一定要談填的資料
            },
            usernames: {
                value: "",
                required: false
            },
            log: {
                value: null
            }
        },
        paletteName: "Facebook Bot",
        credentials: {//定義在這個表私密的資料，不會被匯出
            token: {//粉絲專頁存取權杖（很長的那個）
                type: "text"
            },
            verify_token: {//自己定義的token，要放在Facebook Messenger
                type: "text"
            },
            app_secret: {//Facebook那邊的應用程式密鑰（要打密碼才會顯示）
                type: "text"
            },
            webhookURL: {
                type: "text"
            }
        },
        label: function () {//回傳這裡的botname變數
            return this.botname;
        }
    });

</script>

<script type="text/x-red" data-template-name="FCF-facebook-node">
    <div class="form-row">
        <label for="node-config-input-botname"><i class="icon-bookmark"></i> Bot-Name</label>
        <input type="text" id="node-config-input-botname">
    </div>
    <div class="form-row">
        <label for="node-config-input-token"><i class="icon-cog"></i> Token</label>
        <input type="text" id="node-config-input-token" placeholder="Page Token">
        <div style="max-width: 460px;font-size: 12px;color: #999999;line-height: 14px;margin-top:5px;">
        </div>
    </div>
    <div class="form-row">
        <label for="node-config-input-app_secret"><i class="icon-cog"></i> App Secret</label>
        <input type="text" id="node-config-input-app_secret" placeholder="App Secret">
        <div style="max-width: 460px;font-size: 12px;color: #999999;line-height: 14px;margin-top:5px;">
        </div>
    </div>
    <div class="form-row">
        <label for="node-config-input-verify_token"><i class="icon-random"></i> Verify</label>
        <input type="text" id="node-config-input-verify_token" placeholder="Webhook Token">
        <div style="max-width: 460px;font-size: 12px;color: #999999;line-height: 14px;margin-top:5px;">
        </div>
    </div>
    <div class="form-row">
        <label for="node-config-input-webhookURL"><i class="icon-random"></i> Webhook URL</label>
        <input type="text" id="node-config-input-webhookURL" placeholder="Webhook URL">
        <div style="max-width: 460px;font-size: 12px;color: #999999;line-height: 14px;margin-top:5px;">
        </div>
    </div>
</script>

<script type="text/x-red" data-help-name="FCF-facebook-node">
    <p>
        設置Facebook Messenger Webhook驗證的資料
    </p>
    <h3>Details</h3>
    <dl class="message-properties">
        <dt>Bot-Name</dt>
        <dd>您要給這個機器人(粉絲專頁)的名稱</dd>
        <dt>Token</dt>
        <dd>Token必須從Facebook開發者頁面取得。取得步驟為：
            <ul>
                <li>至您在Facebook開發者頁面創造的Facebook App</li>
                <li>至左邊列表的PRODUCTS的Messenger的Settings</li>
                <li>在Token Generation部分中的Page選擇您要連結的APP</li>
                <li>Page Access Token將會產生Token</li>
            </ul>
        </dd>
        <dt>App Secret(非必填)</dt>
        <dd>App Secret也是須從Facebook開發者頁面取得。取得步驟為：
            <ul>
                <li>至您在Facebook開發者頁面創造的Facebook App</li>
                <li>至左邊列表的Settings的Basic</li>
                <li>App Secret通常位於App ID的右邊，它會以密碼的形式呈現。點擊Show，您需輸入您的Facebook密碼來取得他</li>
            </ul>
        </dd>
        <dt>Verify</dt>
        <dd>Verify為您自定義的驗證碼，通常會定義一串字串，它將被作為Facebook平台對您的Webhook做的一的驗證手段。您需至Facebook開發者頁面的Webhook頁面放置此驗證碼，Webhook頁面位於：
            <ul>
                <li>Facebook開發者頁面創造的Facebook App</li>
                <li>至左邊列表的PRODUCTS的Messenger的Webhooks</li>
                <li>於上方下拉選單選擇Page(通常預設就是Page)，點擊Edit Subscription</li>
                <li>於彈出的視窗中下方的Verify Token欄位填寫您自定義的驗證碼</li>
            </ul>
            驗證碼填寫完畢記得同時設置Callback URL
        </dd>
        <dt>Webhook URL</dt>
        <dd>Webhook URL為您自定義的Webhook Service URL的後綴，填寫格式為/${urlname}，範例：/phonebot，設置完畢後，FCF會幫您啟動一個Webhook Service，
            完整URL為http://localhost:1880/redbot/facebook/phonebot(此完整URL僅供參考，Facebook平台規定Webhook需為公開網址且要有Https，請自行架設)
            ，這段完整URL填寫的位置和Verify驗證碼設置的位置一樣，請將它設置在Verify Token上面那個Callback URL欄位中，而Callback URL欄位的位置請參考上述Verify的說明。
        </dd>
    </dl>
</script>
<!--FCF-facebook-node結束-->


<script type="text/javascript">//Facebook In開始
    RED.nodes.registerType("FCF-facebook-receive", {
        category: "FCF",
        color: "#FFCC66",
        defaults: {
            name: {
                value: "",
            },
            bot: {//此物件存的是facebook的設置節點(就是在config頁籤的節點)的Node的ID，所以最後存的是像這樣的字串:98bd3fe8.c4eb5
                value: "",
                type: "FCF-facebook-node",
                required: true
            }
        },
        inputs: 0,
        outputs: 1,
        icon: "chatbot-receiver.png",
        paletteLabel: "Facebook In",
        label: function () {
            let labelName = "Facebook In";
            if (this.name) {
                return `${labelName} : ${this.name}`;
            }
            else {
                return labelName;
            }
        }
    });

</script>

<script type="text/x-red" data-template-name="FCF-facebook-receive"><!-- Facebook In第二部分 -->
    <div class="form-row">
        <!-- 節點名稱 -->
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-bot"><i class="icon-bookmark"></i> Bot</label>
        <input type="text" id="node-input-bot" placeholder="Bot">
    </div>
</script>

<script type="text/x-red" data-help-name="FCF-facebook-receive">
  <p>
    用來接收從 Facebook 通訊平台送來的訊息
  </p>
</script>
<!-- Facebook Out結束 -->

<script type="text/javascript">//Facebook Out開始
    RED.nodes.registerType("FCF-facebook-send", {
        category: "FCF",
        color: "#FFCC66",
        defaults: {
            name: {
                value: ""
            },
            bot: {
                value: "",
                type: "FCF-facebook-node",
                required: true
            },
            track: {
                value: false
            },
            outputs: {
                value: 0
            },
            fcfFacebookRoleNode: {
            	value: "",
                type: "FCF-facebook-config-role",
                required: false
            }
        },
        inputs: 1,
        outputs: 0,
        icon: "chatbot-sender.png",
        paletteLabel: "Facebook Out",
        label: function () {
            let labelName = "Facebook Out";
            if (this.name) {
                return `${labelName} : ${this.name}`;
            }
            else {
                return labelName;
            }
        },
        oneditsave: function () {
            let track = $("#node-input-track").is(":checked");
            this.outputs = track ? 1 : 0;
        }
    });

</script>

<script type="text/x-red" data-template-name="FCF-facebook-send"><!-- Facebook Out第二部分 -->
    <div class="form-row">
        <!-- 節點名稱 -->
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-bot"><i class="icon-bookmark"></i> Bot</label>
        <input type="text" id="node-input-bot" placeholder="Bot">
    </div>
    <div class="form-row">
        <label for="node-input-fcfFacebookRoleNode"><i class="icon-bookmark"></i> Role</label>
        <input type="text" id="node-input-fcfFacebookRoleNode">
    </div>
    <div class="form-row">
        <label for="node-input-track"><i class="icon-envelope"></i> Track Conversation</label>
        <input type="checkbox" value="true" id="node-input-track">
    <div style="max-width: 460px;font-size: 12px;color: #999999;line-height: 14px;margin-top:5px;">
</script>

<script type="text/x-red" data-help-name="FCF-facebook-send">
    <p>
        用來將訊息傳送至 Facebook 通訊平台
    </p>
</script>
<!-- Facebook Out結束 -->

<!-- 設置角色的節點 -->
<script type="text/javascript">
    RED.nodes.registerType("FCF-facebook-config-role", {
        category: "config",
        defaults: {
            name: {
                value: "",
                required: true
            }
        },
        credentials: {
            targetUserID: {
                type: "text"
            }
        },
        //定義這個config形式的節點在別的節點的dialog所呈現的字串，和在右邊的config sidebar所呈現的字串
        label: function () {
            return this.name || "FCF-facebook-config-role";
        }
    });
</script>

<script type="text/x-red" data-template-name="FCF-facebook-config-role">
    <!-- 注意這裡的id是node-config-input-開頭 -->
        <!-- 定義這個credential節點的名稱 -->
    <div class="form-row">
        <label for="node-config-input-name"><i class="icon-bookmark"></i> Name</label>
        <input type="text" id="node-config-input-name">
    </div>
        <!-- 定義使用者名稱的表單 -->
    <div class="form-row">
        <label for="node-config-input-targetUserID"><i class="icon-bookmark"></i> Target UserID</label>
        <input type="text" id="node-config-input-targetUserID">
    </div>
</script>