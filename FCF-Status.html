<!--這幾個新節點的色票 https://coolors.co/479b4d-ffea32-ff9f4c-ce5eed-5998ff -->
<script type="text/javascript">
    RED.nodes.registerType("FCF-Status", {
        category: "FCF",
        color: "#ffad86",
        defaults: {
            name: {
                value: "",
                required: false
            },
            propertyType: {//物件(型態)
                value: "msg"
            },
            property: {//屬性
                value: "payload",//這個值一定要保留，這樣拉出來才會有預設值
                required: true,
            },
            rules: {
                value: [{
                    comparisonOperator: "eq",//用來儲存條件運算子：== >= <= !=
                    beingComparedPropertyType: "str",//被比較的物件(型態)
                    beingComparedProperty: "DefaultString",//被比較的屬性
                    fill: "red",
                    shape: "ring",
                    text: "disconnected"
                }]
            }
        },
        inputs: 1,
        outputs: 1,
        paletteLabel: "Status",
        icon: "file.png",
        label: function () {
            return this.name || "Status";
        },
        oneditprepare: function () {
            //設置item外的Property
            $("#node-input-property").typedInput({
                default: this.propertyType || "msg",
                types: ["msg", "flow", "global"]
            });
            function resizeRule(rule) {
                let newWidth = rule.width();
                rule.find(".red-ui-typedInput").typedInput("width", newWidth - 130);
            }
            $("#node-input-rule-container").css("min-height", "300px").css("min-width", "450px").editableList({
                addItem: function (container, i, opt) {
                    // console.log(rule);
                    //會印出{comparisonOperator: ""fill: "",shape: "",text: ""}這樣的物件
                    let rule = opt;
                    container.css({
                        overflow: "hidden",
                        whiteSpace: "nowrap"
                    });
                    let row1 = $("<div/>").appendTo(container);
                    let row2 = $("<div/>", { style: "margin-top:8px;" }).appendTo(container);
                    let row3 = $("<div/>", { style: "margin-top:8px;" }).appendTo(container);
                    let row4 = $("<div/>", { style: "margin-top:8px;" }).appendTo(container);

                    //定義運算子下拉選單
                    let selectFieldOperator = $("<select/>", { class: "node-input-rule-property-operator", style: "width:110px; margin-right:10px;" }).appendTo(row1);
                    let selectOptionsOperator = [
                        { v: "eq", l: "==" },
                        { v: "neq", l: "!=" },
                        { v: "lt", l: "<" },
                        { v: "lte", l: "<=" },
                        { v: "gt", l: ">" },
                        { v: "gte", l: ">=" }
                    ];
                    for (let i = 0; i < selectOptionsOperator.length; i++) {
                        selectFieldOperator.append($("<option></option>").val(selectOptionsOperator[i].v).text(selectOptionsOperator[i].l));
                    }
                    // 定義要被比較的物件屬性的表單
                    let propertyValue = $("<input/>", { class: "node-input-rule-property-beingCompared-component", type: "text", value: "DefaultString" })
                        .appendTo(row1)
                        .typedInput({ default: "str", types: ["msg", "flow", "global", "str", "num", "bool", "json"] });

                    //定義status的fill的下拉選單
                    let spanFill = $("<span/>", { text: "Fill", style: "text-align: right;" }).appendTo(row2);
                    let selectFieldFill = $("<select/>", { class: "node-input-rule-property-fill", style: "width:110px; margin-left:48px;" }).appendTo(row2);
                    let selectOptionsFill = [{
                        v: "red",
                        l: "red"
                    },
                    {
                        v: "green",
                        l: "green"
                    },
                    {
                        v: "yellow",
                        l: "yellow"
                    },
                    {
                        v: "blue",
                        l: "blue"
                    },
                    {
                        v: "grey",
                        l: "grey"
                    }];
                    for (let i = 0; i < selectOptionsFill.length; i++) {
                        selectFieldFill.append($("<option></option>").val(selectOptionsFill[i].v).text(selectOptionsFill[i].l));
                    }

                    //定義status的shape的下拉選單
                    let spanShape = $("<span/>", { text: "Shape", style: "text-align: right;" }).appendTo(row3);
                    let selectFieldShape = $("<select/>", { class: "node-input-rule-property-shape", style: "width:110px; margin-left:25px;" }).appendTo(row3);
                    let selectOptionsShape = [{
                        v: "ring",
                        l: "ring"
                    },
                    {
                        v: "dot",
                        l: "dot"
                    }];
                    for (let i = 0; i < selectOptionsShape.length; i++) {
                        selectFieldShape.append($("<option></option>").val(selectOptionsShape[i].v).text(selectOptionsShape[i].l));
                    }

                    // 定義status的text的input
                    let spanStatusText = $("<span/>", { text: "Text", style: "text-align: right;" }).appendTo(row4);
                    let statusText = $("<input/>", { class: "node-input-rule-property-statusText", type: "text", style: "margin-left:40px;", value: "disconnected" }).appendTo(row4);

                    selectFieldOperator.val(rule.comparisonOperator);
                    propertyValue.typedInput("type", rule.beingComparedPropertyType);
                    propertyValue.typedInput("value", rule.beingComparedProperty);
                    selectFieldFill.val(rule.fill);
                    selectFieldShape.val(rule.shape);
                    statusText.val(rule.text);

                    let newWidth = $("#node-input-rule-container").width();
                    resizeRule(container);
                },
                resizeItem: resizeRule,
                removable: true,
                sortable: true
            })
            for (let i = 0; i < this.rules.length; i++) {
                let rule = this.rules[i];
                $("#node-input-rule-container").editableList("addItem", rule);
            }
        },
        oneditsave: function () {
            let rules = $("#node-input-rule-container").editableList("items");
            let node = this;
            node.rules = [];
            this.propertyType = $("#node-input-property").typedInput("type");//type就是["msg", "flow", "global"]這些東西
            this.property = $("#node-input-property").typedInput("value");
            rules.each(function (i) {
                let rule = $(this);
                let r = {
                    comparisonOperator: rule.find(".node-input-rule-property-operator").val(),//用來儲存條件運算子：== >= <= !=
                    beingComparedPropertyType: rule.find(".node-input-rule-property-beingCompared-component").typedInput("type"),//被比較的物件(型態)
                    beingComparedProperty: rule.find(".node-input-rule-property-beingCompared-component").typedInput("value"),//被比較的屬性
                    fill: rule.find(".node-input-rule-property-fill").val(),
                    shape: rule.find(".node-input-rule-property-shape").val(),
                    text: rule.find(".node-input-rule-property-statusText").val()
                };
                node.rules.push(r);
            });
        },
        oneditresize: function (size) {
            let rows = $("#dialog-form>div:not(.node-input-rule-container-row)");
            let height = size.height;
            for (let i = 0; i < rows.size(); i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            let editorRow = $("#dialog-form>div.node-input-rule-container-row");
            height -= (parseInt(editorRow.css("marginTop")) + parseInt(editorRow.css("marginBottom")));

            $("#node-input-rule-container").editableList("height", height);
        }
    });
</script>

<!-- 定義此節點的表單元件 -->
<script type="text/x-red" data-template-name="FCF-Status">
    <!-- 節點名稱 -->
	<div class="form-row">
		<label for="node-input-name"><i class="icon-tag"></i> Name</label>
		<input type="text" id="node-input-name" placeholder="Name">
    </div>
    <!-- property欄位 -->
    <div class="form-row">
        <label data-i18n="switch.label.property"></label>
        <input type="text" id="node-input-property" style="width: 70%"/>
    </div>
    <!-- 設置模式表單，一種是根據使用者定義的條件來顯示狀態，一種是直接顯示某個值或變數 -->
    <div class="form-row">
        <label for=""> Mode </label>
        <select id="node-select-mode">
            <option value="displayStatus">display status according to conditions</option>
            <option value="displayVal">display a value or variable</option>
        </select>
    </div>
    <!-- 定義裝表單項目的容器? -->
        <div class="form-row node-input-rule-container-row">
        <ol id="node-input-rule-container"></ol>
    </div>
</script>

<!-- 定義節點的右邊資訊欄的輔助說明文字 -->
<script type="text/x-red" data-help-name="FCF-Status">
    <p>此節點用來呈現某物件的狀態。</p>
    <p>您可以於此節點設置要存取的物件屬性，並可再設置當此屬性變成某個值的時候，它要呈現什麼狀態。</p>
</script>