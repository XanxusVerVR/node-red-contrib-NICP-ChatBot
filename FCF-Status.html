<!--這幾個新節點的色票 https://coolors.co/479b4d-ffea32-ff9f4c-ce5eed-5998ff -->
<script type="text/javascript">
    RED.nodes.registerType("FCF-Status", {
        category: "FCF",
        color: "#ffad86",
        defaults: {
            name: {
                value: "",
                required: false
            },
            propertyType: {//物件(型態)
                value: "msg"
            },
            property: {//屬性
                value: "payload",//這個值一定要保留，這樣拉出來才會有預設值
                required: true,
            },
            propertyType2: {//用在displayVal模式
                value: "msg"
            },
            property2: {//用在displayVal模式
                value: "payload",
                required: true,
            },
            mode: {
                value: "displayStatus"
            },
            isInputAndOutput: {
                value: true
            },
            inputs: {//將inputs、outputs定義在這也可
				value: 1
			},
			outputs: {
				value: 1
			},
            rules: {
                value: [{
                    comparisonOperator: "eq",//用來儲存條件運算子：== >= <= !=
                    beingComparedPropertyType: "str",//被比較的物件(型態)
                    beingComparedProperty: "DefaultString",//被比較的屬性
                    fill: "red",
                    shape: "ring",
                    text: "disconnected"
                }]
            },
            bigFill: {//用來存放displayVal模式的狀態資料
                value: "red"
            },
            bigShape: {
                value: "ring"
            },
            valStatusUnit: {
                value: "度"
            }
        },
        paletteLabel: "Status",
        icon: "file.png",
        label: function () {
            return this.name || "Status";
        },

        oneditprepare: function () {
            //設置item外displayStatus模式的Property
            $("#node-input-property").typedInput({
                default: this.propertyType || "msg",
                types: ["msg", "flow", "global"]
            });
            $("#node-input-property2").typedInput({
                default: this.propertyType2 || "msg",
                types: ["msg", "flow", "global"]
            });
            function resizeRule(rule) {
                let newWidth = rule.width();
                rule.find(".red-ui-typedInput").typedInput("width", newWidth - 130);
            }
            //切換模式，根據不同的模式看要顯示什麼表單
            $("#node-input-mode").change(function () {
                let value = $(this).val();
                if (value == "displayStatus") {
                    $(".node-input-rule-container-row").show();//讓那個item項目表單列表顯示
                    resizeRule($("div.red-ui-editableList-item-content"));//讓node-input-rule-property-beingCompared-component又出現，不會消失
                    $(".node-input-big-rule-property-fill").hide();
                    $(".node-input-big-rule-property-shape").hide();
                    $(".prop").show();
                    $(".prop2").hide();
                    $(".cUnit").hide();
                } else if (value == "displayVal") {
                    $(".node-input-big-rule-property-fill").show();
                    $(".node-input-big-rule-property-shape").show();
                    $(".node-input-rule-container-row").hide();//讓那個item項目表單列表隱藏
                    $(".prop").hide();
                    $(".prop2").show();
                    $(".cUnit").show();
                }
            });
            $("#node-input-mode").change();

            $("#node-input-rule-container").css("min-height", "300px").css("min-width", "450px").editableList({
                addItem: function (container, i, opt) {
                    let rule = opt;
                    // 讓當加入新項目時，表單會有初始值
                    if (!rule.comparisonOperator || !rule.beingComparedProperty) {
                        rule = {
                            comparisonOperator: "eq",//用來儲存條件運算子：== >= <= !=
                            beingComparedPropertyType: "str",//被比較的物件(型態)
                            beingComparedProperty: "DefaultString",//被比較的屬性
                            fill: "red",
                            shape: "ring",
                            text: "disconnected"
                        };
                    }
                    container.css({
                        overflow: "hidden",
                        whiteSpace: "nowrap"
                    });
                    let row1 = $("<div/>").appendTo(container);
                    let row2 = $("<div/>", { style: "margin-top:8px;" }).appendTo(container);
                    let row3 = $("<div/>", { style: "margin-top:8px;" }).appendTo(container);
                    let row4 = $("<div/>", { style: "margin-top:8px;" }).appendTo(container);

                    //定義運算子下拉選單
                    let selectFieldOperator = $("<select/>", { class: "node-input-rule-property-operator", style: "width:110px; margin-right:10px;" }).appendTo(row1);
                    let selectOptionsOperator = [
                        { v: "eq", l: "==" },
                        { v: "neq", l: "!=" },
                        { v: "lt", l: "<" },
                        { v: "lte", l: "<=" },
                        { v: "gt", l: ">" },
                        { v: "gte", l: ">=" }
                    ];
                    for (let i = 0; i < selectOptionsOperator.length; i++) {
                        selectFieldOperator.append($("<option></option>").val(selectOptionsOperator[i].v).text(selectOptionsOperator[i].l));
                    }
                    // 定義要被比較的物件屬性的表單
                    let propertyValue = $("<input/>", { class: "node-input-rule-property-beingCompared-component", type: "text", value: "DefaultString" })
                        .appendTo(row1)
                        .typedInput({ default: "str", types: ["msg", "flow", "global", "str", "num", "bool", "json"] });

                    //定義status的fill的下拉選單
                    let spanFill = $("<span/>", { text: "Fill", style: "text-align: right;" }).appendTo(row2);
                    let selectFieldFill = $("<select/>", { class: "node-input-rule-property-fill", style: "width:110px; margin-left:48px;" }).appendTo(row2);
                    let selectOptionsFill = [{
                        v: "red",
                        l: "red"
                    },
                    {
                        v: "green",
                        l: "green"
                    },
                    {
                        v: "yellow",
                        l: "yellow"
                    },
                    {
                        v: "blue",
                        l: "blue"
                    },
                    {
                        v: "grey",
                        l: "grey"
                    }];
                    for (let i = 0; i < selectOptionsFill.length; i++) {
                        selectFieldFill.append($("<option></option>").val(selectOptionsFill[i].v).text(selectOptionsFill[i].l));
                    }

                    //定義status的shape的下拉選單
                    let spanShape = $("<span/>", { text: "Shape", style: "text-align: right;" }).appendTo(row3);
                    let selectFieldShape = $("<select/>", { class: "node-input-rule-property-shape", style: "width:110px; margin-left:25px;" }).appendTo(row3);
                    let selectOptionsShape = [{
                        v: "ring",
                        l: "ring"
                    },
                    {
                        v: "dot",
                        l: "dot"
                    }];
                    for (let i = 0; i < selectOptionsShape.length; i++) {
                        selectFieldShape.append($("<option></option>").val(selectOptionsShape[i].v).text(selectOptionsShape[i].l));
                    }

                    // 定義status的text的input
                    let spanStatusText = $("<span/>", { text: "Text", style: "text-align: right;" }).appendTo(row4);
                    let statusText = $("<input/>", { class: "node-input-rule-property-statusText", type: "text", style: "margin-left:40px;", value: "disconnected" }).appendTo(row4);

                    // 有這幾行才可以將使用者填的表單的值存起來
                    selectFieldOperator.val(rule.comparisonOperator);
                    propertyValue.typedInput("type", rule.beingComparedPropertyType);
                    propertyValue.typedInput("value", rule.beingComparedProperty);
                    selectFieldFill.val(rule.fill);
                    selectFieldShape.val(rule.shape);
                    statusText.val(rule.text);

                    let newWidth = $("#node-input-rule-container").width();
                    resizeRule(container);
                },
                resizeItem: resizeRule,
                removable: true,
                sortable: true
            })
            for (let i = 0; i < this.rules.length; i++) {
                let rule = this.rules[i];
                $("#node-input-rule-container").editableList("addItem", rule);
            }
        },
        oneditsave: function () {
            let node = this;
            let isInputAndOutput = $("#node-input-isInputAndOutput").is(":checked");
            if (!isInputAndOutput === true) {
                this.inputs = 0;
                this.outputs = 0;
            }
            else {
                this.inputs = 1;
                this.outputs = 1;
            }
            let rules = $("#node-input-rule-container").editableList("items");
            node.rules = [];
            this.propertyType = $("#node-input-property").typedInput("type");//type就是["msg", "flow", "global"]這些東西
            this.property = $("#node-input-property").typedInput("value");
            this.propertyType2 = $("#node-input-property2").typedInput("type");
            this.property2 = $("#node-input-property2").typedInput("value");
            rules.each(function (i) {
                let rule = $(this);
                let r = {
                    comparisonOperator: rule.find(".node-input-rule-property-operator").val(),//用來儲存條件運算子：== >= <= !=
                    beingComparedPropertyType: rule.find(".node-input-rule-property-beingCompared-component").typedInput("type"),//被比較的物件(型態)
                    beingComparedProperty: rule.find(".node-input-rule-property-beingCompared-component").typedInput("value"),//被比較的屬性
                    fill: rule.find(".node-input-rule-property-fill").val(),
                    shape: rule.find(".node-input-rule-property-shape").val(),
                    text: rule.find(".node-input-rule-property-statusText").val()
                };
                node.rules.push(r);
            });
        },
        oneditresize: function (size) {
            let rows = $("#dialog-form>div:not(.node-input-rule-container-row)");
            let height = size.height;
            for (let i = 0; i < rows.size(); i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            let editorRow = $("#dialog-form>div.node-input-rule-container-row");
            height -= (parseInt(editorRow.css("marginTop")) + parseInt(editorRow.css("marginBottom")));

            $("#node-input-rule-container").editableList("height", height);
        }
    });
</script>

<!-- 定義此節點的表單元件 -->
<script type="text/x-red" data-template-name="FCF-Status">
    <!-- 節點名稱 -->
	<div class="form-row">
		<label for="node-input-name"><i class="icon-tag"></i> Name</label>
		<input type="text" id="node-input-name" placeholder="Name">
    </div>
    <!-- 設置模式表單，一種是根據使用者定義的條件來顯示狀態，一種是直接顯示某個值或變數 -->
    <div class="form-row">
        <label for=""> Mode </label>
        <select id="node-input-mode">
                <!-- 根據使用者定義的條件來顯示狀態 -->
            <option value="displayStatus">display status according to conditions</option>
                <!-- 直接顯示某個值或變數 -->
            <option value="displayVal">display a value or variable</option>
        </select>
    </div>
    <!-- 設置是否要有輸入輸出 -->
    <div class="form-row cNode-input-isInputAndOutput">
    <label></label>
        <input type="checkbox" id="node-input-isInputAndOutput" style="margin-left: 0px; vertical-align: top; width: auto !important;"> <label style="width:auto !important;" for="node-input-isInputAndOutput">Is there an input and output?</label>
    </div>
    <!-- property欄位，在displayStatus模式用的 -->
    <div id="bigPropertyForm" class="form-row prop">
        <label data-i18n="switch.label.property"></label>
        <input type="text" id="node-input-property" style="width: 70%"/>
    </div>
    <!-- 定義Status的Fill欄位 -->
    <div class="form-row node-input-big-rule-property-fill">
        <label for="node-input-big-rule-property-fill"> Fill </label>
        <select id="node-input-bigFill" class="node-input-big-rule-property-fill">
            <option value="red">red</option>
            <option value="green">green</option>
            <option value="yellow">yellow</option>
            <option value="blue">blue</option>
            <option value="grey">grey</option>
        </select>
    </div>
    <p></p>
    <!-- 定義Status的Shape欄位 -->
    <div id="bigShapeForm" class="form-row node-input-big-rule-property-shape">
        <label for="node-input-big-rule-property-shape"> Shape </label>
        <select id="node-input-bigShape" class="node-input-big-rule-property-shape">
            <option value="ring">ring</option>
            <option value="dot">dot</option>
        </select>
    </div>
    <!-- property欄位，在displayVal模式用的 -->
    <div class="form-row prop2">
        <label for="node-input-property2">Text</label>
        <input type="text" id="node-input-property2" style="width: 70%"/>
    </div>
    <!-- 定義單位欄位 -->
    <div class="form-row cUnit">
        <label for="node-input-valStatusUnit">Unit</label>
        <input type="text" id="node-input-valStatusUnit" style="width: 70%"/>
    </div>
    <!-- 定義裝表單項目的容器? -->
        <div class="form-row node-input-rule-container-row">
        <ol id="node-input-rule-container"></ol>
    </div>
</script>

<!-- 定義節點的右邊資訊欄的輔助說明文字 -->
<script type="text/x-red" data-help-name="FCF-Status">
    <p>此節點用來呈現某物件的狀態。</p>
    <p>您可以於此節點設置要存取的物件屬性，並可再設置當此屬性變成某個值的時候，它要呈現什麼狀態。</p>
</script>