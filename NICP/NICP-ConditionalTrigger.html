<script type="text/x-red" data-template-name="NICP-ConditionalTrigger">
    <div class="form-row">
        <!-- 給輸入此節點的識別名稱 -->
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name" />
    </div>
    <div class="form-row">
        <!-- 給輸入此節點輸出的主題 -->
        <label for="node-input-outputTopic"><i class="fa fa-tasks"></i> Topic</label>
        <input type="text" id="node-input-outputTopic" placeholder="Topic" />
    </div>
    <!-- select option：看使用者要選哪一筆context節點資料 -->
	<div class="form-row nodeConfigDataOption">
        <label for="node-input-nodeContextConfigDats" style="width:100%;"><i class="fa fa-tag"></i> Context File Node Config Data</label>
        <select id="node-input-nodeContextConfigDats" class="nodeConfigDataOption">
            <!-- <option value="red">red</option> -->
        </select>
    </div>
    <div class="form-row">
        <!-- 提供選擇這節點是要and還or -->
        <label for="node-input-gateType"><i class="fa fa-cog"></i> Type</label>
        <select id="node-input-gateType" name="node-input-gateType">
            <option value="and">AND</option>
            <option value="nand">NAND</option>
            <option value="or">OR</option>
            <option value="nor">NOR</option>
            <option value="xor">XOR</option>
            <option value="xnor">XNOR</option>
        </select>
    </div>
    <div class="form-row">
        <!-- 那個True restriction勾選單 -->
        <label for="node-input-emitOnlyIfTrue" style="width:25%;"><i class="fa fa-times"></i> True restriction</label>
        <input type="checkbox" id="node-input-emitOnlyIfTrue" style="width:15%;"/>
    </div>
        <!-- item表單 -->
    <label for="node-input-rule-container"><i class="fa fa-cogs"></i> Rules</label>
    <div class="form-row node-input-rule-container-row">
        <ol id="node-input-rule-container"></ol>
    </div>
</script>

<script type="text/x-red" data-help-name="NICP-ConditionalTrigger">
    <p>A node to perform AND and NAND gate, according to predefined rules.</p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>topic(mandatory)
            <span class="property-type">string</span>
        </dt>
        <dd> the topic of the message. This is mandatory because of the node configuration </dd>
        <dt>
            <any property>
                <span class="property-type">string | number | object | bool</span>
        </dt>
        <dd> the property to test </dd>
    </dl>

    <h3>Outputs</h3>
    <ol class="node-ports">
        <li>Standard output
            <dl class="message-properties">
                <dt>topic <span class="property-type">string</span></dt>
                <dd>the node's defined topic</dd>
                <dt>payload <span class="property-type">string | object</span></dt>
                <dd>the payload of the message that trigged the node</dd>
                <dt>bool <span class="property-type">bool</span></dt>
                <dd>the result of the node</dd>
            </dl>
        </li>
    </ol>

    <h3>Configuration</h3>
    <p>You can add a rule by clicking on the add button below the Rule's list.</p>

    <dl class="message-properties">
        <dt>Name <span class="property-type">string</span></dt>
        <dd>the name of the node</dd>
        <dt>Topic <span class="property-type">string</span></dt>
        <dd>the msg output topic</dd>
        <dt>Type <span class="property-type">AND | NAND</span></dt>
        <dd>define the gate of the node</dd>
        <dt>True restriction <span class="property-type">checkbox</span></dt>
        <dd>if checked, the node will output message only if the condition is true</dd>
    </dl>

    <p>A rule can be read from top, like :</p>
    <p><strong>&lt;TOPIC&gt;&lt;PROPERTY&gt;&lt;CONDITION&gt;&lt;VALUE&gt;</strong></p>
    <p>Depending on your selection, some input may disapear, because they're not pertinent.</p>
    <dl class="message-properties">
        <dt>TOPIC <span class="property-type">string</span></dt>
        <dd>the topic of the message that come in</dd>
        <dt>PROPERTY <span class="property-type">properties</span></dt>
        <dd>the property to check</dd>
        <dt>CONDITION </dt>
        <dd>the property condition</dd>
        <dt>VALUE <span class="property-type">number | string | properties | previousValue</span></dt>
        <dd>the value that the property need to check</dd>
    </dl>

    <h3>Details</h3>
    <p>A message come into the node. The node will evaluate it according to the configuration. Please take your time for it.</p>

</script>

<script type="text/javascript">
    RED.nodes.registerType("NICP-ConditionalTrigger", {
        color: "#be77ff",
        category: "NICP",
        defaults: {
            name: {
                value: ""
            },
            rules: {
                value: [{
                    topic: "",
                    property: "payload",
                    propertyType: "msg",
                    t: "eq", // 運算子
                    v: "" // 值
                }]
            },
            configDataId: {
                value: ""
            },
            outputTopic: {
                value: ""
            },
            gateType: {
                value: "and",
                required: true
            },
            emitOnlyIfTrue: {
                value: false
            },
        },
        paletteLabel: "Conditional Trigger",
        inputs: 1,
        inputLabels: "Msg to evaluate / trigger",
        outputs: 1,
        outputLabels: "Result of the AND condition",
        icon: "switch.png",
        label: function () {
            let labelName = "Conditional Trigger";
            if (this.name) {
                return `${labelName} : ${this.name}`;
            }
            else {
                return labelName;
            }
        },
        oneditprepare: function () {
            // this.type是這個節點的類型，如：lower-case。為字串
            let showContextList = function () {
                $.when(
                    // 取得這個類型的節點，此節點是NICP-ConditionalTrigger，那他就只會從Context File拿NICP-ConditionalTrigger類型的節點
                    $.getJSON(`context/flow/${this.z}`)
                ).then((data1) => {
                    let theNodeConfigDatasArray;
                    // 檢查Context檔案系統中是否儲存這個類型的節點
                    try {
                        theNodeConfigDatasArray = JSON.parse(data1.xanxusContext[this.type].msg);
                    } catch (TypeError) {
                        console.log("抱歉，目前ContextFile中還沒有這個節點的資料唷！");
                        console.log(TypeError);
                        return;
                    }

                    let node = this;
                    // 動態生成option
                    let nodeContextConfigDatsOption = [];
                    for (let i = 0; i < theNodeConfigDatasArray.length; i++) {
                        let optionObject = {
                            v: theNodeConfigDatasArray[i].id,
                            l: theNodeConfigDatasArray[i].name
                        }
                        nodeContextConfigDatsOption.push(optionObject);
                    }

                    $("#node-input-nodeContextConfigDats").append($("<option/>", { selected: true, text: "--", value: "--" }));
                    for (let i = 0; i < nodeContextConfigDatsOption.length; i++) {
                        $("#node-input-nodeContextConfigDats").append($("<option></option>").val(nodeContextConfigDatsOption[i].v).text(nodeContextConfigDatsOption[i].l));
                    }
                    // 如果上次有設置了某節點資料，則找到他，並把option設為上次選中的那筆資料
                    if (this.configDataId && this.configDataId != "--") {
                        $("#node-input-nodeContextConfigDats option").each(function () {
                            if ($(this).val() == node.configDataId) {
                                $(this).prop("selected", true);
                            }
                        });
                    }
                    let updateData = function _updateData(id) {
                        // 如果id存在，表示使用者現在是有選擇某個Context File的Node設定資料，那就要做更新的動作
                        if (id && id != "--") {
                            $("#node-input-rule-container").editableList("empty");//當使用者更換別的節點設置資料時，舊的要清空，不然item會一直累加
                            //找出被選中的資料，並取出來然後跟著跟新到畫面上
                            for (let i = 0; i < theNodeConfigDatasArray.length; i++) {
                                // 如果找到了id 一樣 就做更新
                                if (theNodeConfigDatasArray[i].id == id) {
                                    // 開始更新啦
                                    $("#node-input-name").val(theNodeConfigDatasArray[i].name);
                                    $("#node-input-outputTopic").val(theNodeConfigDatasArray[i].outputTopic);
                                    $("#node-input-gateType option").each(function () {
                                        if ($(this).val() == theNodeConfigDatasArray[i].gateType) {
                                            $(this).prop("selected", true);
                                        }
                                    });
                                    $("#node-input-emitOnlyIfTrue").prop("checked", theNodeConfigDatasArray[i].emitOnlyIfTrue);
                                    for (let j = 0; j < theNodeConfigDatasArray[i].rules.length; j++) {
                                        let _data = theNodeConfigDatasArray[i].rules[j];
                                        $("#node-input-rule-container").editableList("addItem", _data);
                                    }
                                    // 將元素停用，不要讓使用者輸入，因為他選擇了要用Context的，就不該讓他再改Context節點的資料了
                                    $("#node-input-name").prop("disabled", true);
                                    $("#node-input-outputTopic").prop("disabled", true);
                                    $("#node-input-gateType").prop("disabled", true);
                                    $("#node-input-emitOnlyIfTrue").prop("disabled", true);
                                }
                            }
                        }
                        else{
                            $(".node-input-rule-container-row input").prop("disabled", false);
                            $(".node-input-rule-select").prop("disabled", false);
                        }
                    }
                    // 當使用者一更換其他Context節點，就要找到使用者選的這個Context節點的id，為了之後找到這個id底下的節點的資料，以便做更新成Context節點的資料
                    $("#node-input-nodeContextConfigDats").change(function () {
                        const id = $(this).val();
                        // 當他換回-- 那其他的要把它打開，開回來
                        if (id == "--") {
                            $("#node-input-name").prop("disabled", false);
                            $("#node-input-outputTopic").prop("disabled", false);
                            $("#node-input-gateType").prop("disabled", false);
                            $("#node-input-emitOnlyIfTrue").prop("disabled", false);
                            $(".node-input-rule-container-row input").prop("disabled", false);
                            $(".node-input-rule-select").prop("disabled", false);
                        }
                        else {
                            updateData(id);
                        }
                    });
                    updateData();
                }).fail(function (problem) {
                    console.log(problem);
                });
            }.bind(this);

            showContextList();

            let node = this;
            // Adding this type for typed input
            let previousValueType = { value: "prev", label: "previous value", hasValue: false };
            let operators = [
                { v: "eq", t: "==" },
                { v: "neq", t: "!=" },
                { v: "lt", t: "<" },
                { v: "lte", t: "<=" },
                { v: "gt", t: ">" },
                { v: "gte", t: ">=" },
                { v: "btwn", t: "is between" },
                { v: "cont", t: "contains" },
                { v: "regex", t: "match regex" },
                { v: "true", t: "is true" },
                { v: "false", t: "is false" },
                { v: "null", t: "is null" },
                { v: "nnull", t: "is not null" }
            ];

            let andLabel = "and";
            let caseLabel = "ignore case";

            function resizeRule(rule) {
                let newWidth = rule.width();
                let topicField = rule.find(".node-input-rule-input-topic");
                topicField.typedInput("width", "95%");
                let propertyField = rule.find(".node-input-rule-property");
                let selectField = rule.find("select");
                propertyField.typedInput("width", Math.trunc(newWidth / 2) - 10);
                selectField.width(Math.trunc(newWidth / 2) - 25);
                let type = selectField.val() || "eq";
                let valueField = rule.find(".node-input-rule-value");
                let btwnField1 = rule.find(".node-input-rule-btwn-value");
                let btwnLabel = rule.find(".node-input-rule-btwn-label");
                let btwnField2 = rule.find(".node-input-rule-btwn-value2");
                let regexField = rule.find(".node-input-rule-regex");
                let caseSensitive = rule.find(".node-input-rule-case");
                let caseLabel = rule.find(".node-input-rule-case-label");

                switch (type) {
                    case "btwn": {
                        btwnField1.typedInput("width", Math.trunc(newWidth / 2) - (btwnLabel.width() / 2) - 10)
                        btwnField2.typedInput("width", Math.trunc(newWidth / 2) - (btwnLabel.width() / 2) - 10)
                        break;
                    }
                    case "regex": {
                        regexField.typedInput("width", newWidth - caseSensitive.width() - caseLabel.width() - 20)
                        break;
                    }
                    default: {
                        valueField.typedInput("width", "95%");
                        break;
                    }
                }
            }

            $("#node-input-rule-container").css("min-height", "250px").css("min-width", "450px").editableList({
                addItem: function (container, i, opt) {
                    let rule = opt;

                    // If t isn"t defined, set equal as default value
                    if (!rule.hasOwnProperty("t")) {
                        rule.t = "eq";
                    }

                    //Adding row to the list
                    let topicRow = $("<div/>").appendTo(container);
                    let propertyRow = $("<div/>", { style: "padding-top: 5px;" }).appendTo(container);
                    let valueRow = $("<div/>", { style: "padding-top: 5px;" }).appendTo(container);

                    let topicField = $("<input/>", { class: "node-input-rule-input-topic", type: "text", style: "margin-left: 5px;", placeholder: "input message topic" }).appendTo(topicRow).typedInput({ default: "str", types: ["str"] });
                    let propertyField = $("<input/>", { class: "node-input-rule-property", type: "text", style: "margin-left: 5px;" }).appendTo(propertyRow).typedInput({ default: rule.propertyType || "msg", types: ["msg", "flow", "global"] });
                    let selectField = $("<select/>", { class:"node-input-rule-select", style: "width:120px; margin-left: 5px; text-align: center;" }).appendTo(propertyRow);
                    for (let d in operators) {
                        selectField.append($("<option></option>").val(operators[d].v).text(operators[d].t));
                    }

                    let valueField = $("<input/>", { class: "node-input-rule-value", type: "text", style: "margin-left: 5px;", placeholder: "value" }).appendTo(valueRow).typedInput({ default: "str", types: ["msg", "flow", "global", "str", "num", previousValueType] });
                    let btwnValueField = $("<input/>", { class: "node-input-rule-btwn-value", type: "text", style: "margin-left: 5px;" }).appendTo(valueRow).typedInput({ default: "num", types: ["msg", "flow", "global", "num", previousValueType] });
                    let btwnAndLabel = $("<span/>", { class: "node-input-rule-btwn-label" }).text(" " + andLabel + " ").appendTo(valueRow);
                    let btwnValue2Field = $("<input/>", { class: "node-input-rule-btwn-value2", type: "text", style: "margin-left:2px;" }).appendTo(valueRow).typedInput({ default: "num", types: ["msg", "flow", "global", "num", previousValueType] });
                    let regexField = $("<input/>", { class: "node-input-rule-regex", type: "text", style: "margin-left:5px;" }).appendTo(valueRow).typedInput({ default: "re", types: ["re"] });
                    let caseSensitive = $("<input/>", { class: "node-input-rule-case", type: "checkbox", style: "margin-left:5px;width:auto;" }).appendTo(valueRow);
                    let formCaseLabel = $("<label/>", { class: "node-input-rule-case-label", for: "node-input-rule-case", style: "margin-left: 3px;" }).text(caseLabel).appendTo(valueRow);

                    // 如果是選到--，表示使用者要自己定義，那元素就要打開，不要禁用，故disabled屬性要設false來給他禁用
                    if ($("#node-input-nodeContextConfigDats").children("option:selected").val() === "--") {
                        $(".node-input-rule-container-row input").prop("disabled", false);
                        selectField.prop("disabled", false);
                    }
                    else {
                        $(".node-input-rule-container-row input").prop("disabled", true);
                        selectField.prop("disabled", true);
                    }

                    selectField.change(function () {
                        resizeRule(container);
                        let selected = selectField.val() || "eq";
                        switch (selected) {
                            case "btwn": {
                                valueField.typedInput("hide");
                                btwnValueField.typedInput("show");
                                btwnAndLabel.show();
                                btwnValue2Field.typedInput("show");
                                regexField.typedInput("hide");
                                caseSensitive.hide();
                                formCaseLabel.hide();
                                break;
                            }
                            case "regex": {
                                valueField.typedInput("hide");
                                btwnValueField.typedInput("hide");
                                btwnAndLabel.hide();
                                btwnValue2Field.typedInput("hide");
                                regexField.typedInput("show");
                                caseSensitive.show();
                                formCaseLabel.show();
                                break;
                            }
                            case "true":
                            case "false":
                            case "null":
                            case "nnull": {
                                valueField.typedInput("hide");
                                btwnValueField.typedInput("hide");
                                btwnAndLabel.hide();
                                btwnValue2Field.typedInput("hide");
                                regexField.typedInput("hide");
                                caseSensitive.hide();
                                formCaseLabel.hide();
                                break;
                            }
                            default: {
                                valueField.typedInput("show");
                                btwnValueField.typedInput("hide");
                                btwnAndLabel.hide();
                                btwnValue2Field.typedInput("hide");
                                regexField.typedInput("hide");
                                caseSensitive.hide();
                                formCaseLabel.hide();
                                break;
                            }
                        }
                    });

                    // Show the messageTopic field or not
                    propertyField.change(function (type, value) {
                        resizeRule(container);
                        if (value === "msg")
                            topicField.typedInput("show");
                        else if (value != undefined)
                            topicField.typedInput("hide");
                    });

                    //save the selected field
                    selectField.val(rule.t);

                    //set value as defined
                    propertyField.typedInput("value", rule.property || "payload");
                    propertyField.typedInput("type", rule.propertyType || "msg");
                    topicField.typedInput("value", rule.topic);
                    if (rule.t == "btwn") {
                        btwnValueField.typedInput("value", rule.v);
                        btwnValueField.typedInput("type", rule.vt || "num");// 這的rule.vt的vt沒有在一開始的defaults那裡定義，但這裡還是會有作用，也會存到.js檔那裡
                        btwnValue2Field.typedInput("value", rule.v2);
                        btwnValue2Field.typedInput("type", rule.v2t || "num");
                    } else if (typeof rule.v != "undefined") {
                        if (rule.t == "regex") {
                            regexField.typedInput("value", rule.v)
                        } else {
                            valueField.typedInput("value", rule.v);
                            valueField.typedInput("type", rule.vt || "str");
                        }
                    }
                    if (rule.case) {
                        caseSensitive.prop("checked", true);
                    } else {
                        caseSensitive.prop("checked", false);
                    }
                    selectField.change();
                },
                resizeItem: resizeRule,
                sortable: false,
                removable: true
            });
            for (let i = 0; i < this.rules.length; i++) {
                let rule = this.rules[i];
                $("#node-input-rule-container").editableList("addItem", rule);
            }
        },
        oneditsave: function () {
            let rules = $("#node-input-rule-container").editableList("items");
            let node = this;
            node.rules = [];
            rules.each(function (i) {
                let rule = $(this);
                // Get the selected operator
                let type = rule.find("select").val();
                // format rule
                let r = { t: type };
                if (!(type === "true" || type === "false" || type === "null" || type === "nnull")) {
                    if (type === "btwn") {
                        r.v = rule.find(".node-input-rule-btwn-value").typedInput("value");
                        r.vt = rule.find(".node-input-rule-btwn-value").typedInput("type");
                        r.v2 = rule.find(".node-input-rule-btwn-value2").typedInput("value");
                        r.v2t = rule.find(".node-input-rule-btwn-value2").typedInput("type");
                    } else {
                        r.v = rule.find(".node-input-rule-value").typedInput("value");
                        r.vt = rule.find(".node-input-rule-value").typedInput("type");
                    }
                    if (type === "regex") {
                        r.v = rule.find(".node-input-rule-regex").typedInput("value");
                        r.case = rule.find(".node-input-rule-case").prop("checked");
                    }
                }
                r.propertyType = rule.find(".node-input-rule-property").typedInput("type");
                r.property = rule.find(".node-input-rule-property").typedInput("value");

                if (r.propertyType === "msg") { // if it"s a message, store the message topic
                    r.topic = rule.find(".node-input-rule-input-topic").typedInput("value");
                }
                node.rules.push(r);
            });
            // 把現在選到的id存起來
            node.configDataId = $("#node-input-nodeContextConfigDats").children("option:selected").val();
        },
        oneditresize: function (size) {
            let rows = $("#dialog-form>div:not(.node-input-rule-container-row)");
            let height = size.height;
            for (let i = 0; i < rows.size(); i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            let editorRow = $("#dialog-form>div.node-input-rule-container-row");
            height -= (parseInt(editorRow.css("marginTop")) + parseInt(editorRow.css("marginBottom")));
            $("#node-input-rule-container").editableList("height", height);
        }
    });

</script>