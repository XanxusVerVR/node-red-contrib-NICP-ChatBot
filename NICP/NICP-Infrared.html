<!-- 載入我的外部函式庫 -->
<script type="text/javascript" src="static/js/my-function.js"></script>

<!-- Infrared Config Node -->
<script type="text/javascript">
    RED.nodes.registerType('lirc-controller', {
        category: 'config',
        defaults: {
            name: { value: "" }
        },
        label: function () {
            return (this.name || 'lirc-controller');
        }
    });
</script>

<script type="text/x-red" data-template-name="lirc-controller">
    <div class="form-row">
        <label for="node-config-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name">
    </div>
</script>

<script type="text/x-red" data-help-name="lirc-controller">
</script>

<!-- Infrared In Node -->
<script type="text/javascript">
    RED.nodes.registerType("NICP-Infrared In", {
        category: "NICP",
        color: "#FF7878",
        defaults: {
            name: {
                value: "",
            },
            listenDevice: {
                value: "",
            },
            listenCommand: {
                value: "",
            }
        },
        inputs: 0,
        outputs: 1,
        icon: "debug.png",
        paletteLabel: "Infrared In",
        label: function () {
            let labelName = "Infrared In";
            if (this.name) {
                return `${labelName} : ${this.name}`;
            }
            else {
                return labelName;
            }
        },
        oneditprepare: function () { //當使用者打開此節點的Edit dialog畫面時要做的事
            const node = this;
            $.getJSON("available-device-list", function (data) {

                // 過濾裝置資料，如要去除空白的
                let availableDeviceList = filterArray(data.split("\n"));

                //定義已存在的可用裝置的下拉選單
                for (let i = 0; i < availableDeviceList.length; i++) {
                    $("#node-input-listenDevice").append($("<option></option>").val(availableDeviceList[i]).text(availableDeviceList[i]));
                }

                // 當這下拉選單更換時觸發
                $("#node-input-listenDevice").change(function () {
                    const deviceName = $(this).val();
                    // 當每次一更換裝置，就要把上次的清空，不然會一直累積
                    $("#node-input-listenCommand option").remove();
                    // 取得這個裝置底下有的指令
                    $.getJSON(`device/command/${deviceName}`, function (commandList) {
                        // 過濾指令資料，如要去除空白的
                        let newCommandList = filterArray(commandList.split("\n"));
                        // 將每個指令取出來，並放到指令的select option裡面
                        for (let i = 0; i < newCommandList.length; i++) {
                            let blankIndex = newCommandList[i].indexOf(" ");
                            let command = newCommandList[i].substring(blankIndex + 1);
                            // 製作option
                            let selectCommandOption = $("<option/>", {
                                "val": command,
                                "text": command
                            });
                            // 將做好的option加到#node-input-listenCommand這個select底下
                            $(selectCommandOption).appendTo("#node-input-listenCommand");
                        }
                        // 如果上次有設置了某節點資料，則找到他，並把option設為上次選中的那筆資料
                        if (node.listenCommand) {
                            $("#node-input-listenCommand option").each(function () {
                                if ($(this).val() == node.listenCommand) {
                                    $(this).prop("selected", true);
                                }
                            });
                        }
                    })
                });
                // 如果上次有設置了某節點資料，則找到他，並把option設為上次選中的那筆資料
                if (node.listenDevice) {
                    $("#node-input-listenDevice option").each(function () {
                        if ($(this).val() == node.listenDevice) {
                            $(this).prop("selected", true);
                        }
                    });
                }
                // 先呼叫一次，這樣第一次打開才會有效果，不然還要手動再選一次才有效果
                $("#node-input-listenDevice").change();
            });
        },
        oneditsave: function () {//當使用者在Edit dialog設置(編輯)完成，按下Done要做的事
            const node = this;
            const selectedDeviceVal = $("#node-input-listenDevice").children("option:selected").val();
            node.listenDevice = selectedDeviceVal;

            const selectedCommandVal = $("#node-input-listenCommand").children("option:selected").val();
            node.listenCommand = selectedCommandVal;
        },
        oneditcancel: function () {//當使用者在Edit dialog按下Cancel要做的事
        },
        oneditdelete: function () {
        },
        onpaletteadd: function () {//此節點只要存在於palette(就是左邊直的那排，還沒拉出來)就會做的事，還沒拉出來也會觸發，重新整理也會觸發
        },
        onpaletteremove: function () {// 沒試過，但應該是從palette移除就會觸發
        }
    });

</script>

<script type="text/x-red" data-template-name="NICP-Infrared In">
    <div class="form-row">
        <!-- 節點名稱 -->
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <!-- 可用的裝置檔下拉選單 -->
    <div class="form-row">
        <label for="node-input-listenDevice" style="width:100%;"><i class="icon-bookmark"></i> Set Listen Device </label>
        <select id="node-input-listenDevice">
        </select>
    </div>
    <!-- 設置要監聽的訊號指令 -->
    <div class="form-row">
        <label for="node-input-listenCommand" style="width:100%;"><i class="icon-bookmark"></i> Set Listen Command </label>
        <select id="node-input-listenCommand">
        </select>
    </div>
</script>

<script type="text/x-red" data-help-name="NICP-Infrared In">
</script>

<!-- Infrared Out Node -->
<script type="text/x-red" data-template-name="NICP-Infrared Out">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-controller"><i class="icon-bookmark"></i> Controller</label>
        <input type="text" id="node-input-controller">
    </div>
    <!-- 可用的裝置檔下拉選單 -->
    <div class="form-row">
        <label for="node-input-device" style="width:100%;"><i class="icon-bookmark"></i> Available Device List </label>
        <select id="node-input-device">
        </select>
    </div>
    <!-- Command List清單 -->
    <div class="form-row">
        <!-- border-bottom:1px solid #eee; 會在這元素底下設置一個分隔線。solid是實線、寬度1px、#eee是偏灰色的 -->
        <label for="commandList" style="width:100%; border-bottom:1px solid #eee;"><i class="fa fa-list-ol"></i> <span>Command List</span></label>
        <ol id="commandList">
        </ol>
    </div>
    <div class="form-row">
        <label for="node-input-output"><i class="icon-bookmark"></i> Output</label>
        <input type="text" id="node-input-output" placeholder="1">
    </div>
</script>

<script type="text/x-red" data-help-name="NICP-Infrared Out">
    <p>
        Use this to <b>send</b> commands via an lirc daemon connected to a Lirc device.<br/>
    	<b>msg.payload</b> must be contain the name of the command
    </p>
    <p>
        For example: <code>KEY_POWER</code>
    </p>
    <br/>
    <p>
        For example, let configs be:
        <ul>
        	<li><code>Name</code> is <code>TV</code> - the name of the node</li>
        	<li><code>Device name</code> is <code>philips</code> - the device name in the file lircd.conf</li>
        	<li><code>Output</code> is <code>1</code> - the number of the transmitter for lirc - may be not supported</li>
        </ul>
    </p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('NICP-Infrared Out', {
        category: 'NICP',
        color: '#FF7878',
        defaults: {
            name: { value: "" },
            controller: { value: "", type: "lirc-controller" },
            device: { value: "", required: true },
            output: { value: "", required: true, validate: RED.validators.number() }
        },
        inputs: 1,
        outputs: 0,
        paletteLabel: "Infrared Out",
        align: 'right',
        icon: "bridge-dash.png",
        label: function () {
            let labelName = "Infrared Out";
            if (this.name) {
                return `${labelName} : ${this.name}`;
            }
            else {
                return labelName;
            }
        },
        oneditprepare: function () {
            const node = this;

            $.getJSON("available-device-list", function (data) {

                let availableDeviceList = filterArray(data.split("\n"));

                //定義已存在的可用裝置的下拉選單
                for (let i = 0; i < availableDeviceList.length; i++) {
                    $("#node-input-device").append($("<option></option>").val(availableDeviceList[i]).text(availableDeviceList[i]));
                }

                // 當這下拉選單更換時觸發
                $("#node-input-device").change(function () {
                    const deviceName = $(this).val();
                    $("#commandList li").remove();
                    $.getJSON(`device/command/${deviceName}`, function (commandList) {
                        let newCommandList = filterArray(commandList.split("\n"));
                        for (let i = 0; i < newCommandList.length; i++) {
                            let blankIndex = newCommandList[i].indexOf(" ");
                            let command = newCommandList[i].substring(blankIndex + 1);
                            let liTag = $("<li/>", {
                                "text": command
                            });
                            $(liTag).appendTo("#commandList");
                        }
                    })
                });

                // 如果上次有設置了某節點資料，則找到他，並把option設為上次選中的那筆資料
                if (node.device) {
                    $("#node-input-device option").each(function () {
                        if ($(this).val() == node.device) {
                            $(this).prop("selected", true);
                        }
                    });
                }

                // 因一開始資料還沒回來，所以這時呼叫會沒東西，故先拿掉
                $("#node-input-device").change();// 先呼叫一次，這樣第一次打開才會有效果，不然還要手動再選一次才有效果
            });
        },
        oneditsave: function () {
            const node = this;
            const selectedVal = $("#node-input-device").children("option:selected").val();
            node.device = selectedVal;
        }
    });
</script>