<script type="text/javascript">//NICP-facebook-node開始
    RED.nodes.registerType("NICP-facebook-node", {//NICP-facebook-node表示整個Facebook Node，包含Facebook In Facebook Out
        category: "config",//定義成config不會出現在面板左邊
        defaults: {
            botname: {
                value: "",
                required: true//表示一定要談填的資料
            },
            usernames: {
                value: "",
                required: false
            },
            log: {
                value: null
            },
            isHttps: {
                value: false
            },
            serverLocation: {
                value: "",
                required: false
            }
        },
        paletteName: "Facebook Bot",
        credentials: {//定義在這個表私密的資料，不會被匯出
            token: {//粉絲專頁存取權杖（很長的那個）
                type: "text"
            },
            verify_token: {//自己定義的token，要放在Facebook Messenger
                type: "text"
            },
            app_secret: {//Facebook那邊的應用程式密鑰（要打密碼才會顯示）
                type: "text"
            },
            webhookURL: {
                type: "text"
            }
        },
        label: function () {//回傳這裡的botname變數
            return this.botname;
        },
        oneditsave: function () {
            let isHttps = $("#node-config-input-serverLocation").is(":checked");
            this.isHttps = isHttps ? true : false;
        }
    });

</script>

<script type="text/x-red" data-template-name="NICP-facebook-node">
    <div class="form-row">
        <label for="node-config-input-botname"><i class="icon-bookmark"></i> Bot-Name</label>
        <input type="text" id="node-config-input-botname">
    </div>
    <div class="form-row">
        <label for="node-config-input-token"><i class="icon-cog"></i> Token</label>
        <input type="text" id="node-config-input-token" placeholder="Page Token">
        <div style="max-width: 460px;font-size: 12px;color: #999999;line-height: 14px;margin-top:5px;">
        </div>
    </div>
    <div class="form-row">
        <label for="node-config-input-app_secret"><i class="icon-cog"></i> App Secret</label>
        <input type="text" id="node-config-input-app_secret" placeholder="App Secret">
        <div style="max-width: 460px;font-size: 12px;color: #999999;line-height: 14px;margin-top:5px;">
        </div>
    </div>
    <div class="form-row">
        <label for="node-config-input-verify_token"><i class="icon-random"></i> Verify</label>
        <input type="text" id="node-config-input-verify_token" placeholder="Webhook Token">
        <div style="max-width: 460px;font-size: 12px;color: #999999;line-height: 14px;margin-top:5px;">
        </div>
    </div>
    <div class="form-row">
        <label for="node-config-input-webhookURL"><i class="icon-random"></i> Webhook URL</label>
        <input type="text" id="node-config-input-webhookURL" placeholder="/path">
        <div style="max-width: 460px;font-size: 12px;color: #999999;line-height: 14px;margin-top:5px;">
        </div>
    </div>
    <div class="form-row">
        <label for="node-config-input-isHttps"><i class="icon-envelope"></i> IsHttps?</label>
        <input type="checkbox" value="true" id="node-config-input-isHttps">
        <div style="max-width: 460px;font-size: 12px;color: #999999;line-height: 14px;margin-top:5px;">
        </div>
    </div>
    <div class="form-row">
        <label for="node-config-input-serverLocation"><i class="icon-random"></i> Server Location</label>
        <input type="text" id="node-config-input-serverLocation" placeholder="Server Location">
        <div style="max-width: 460px;font-size: 12px;color: #999999;line-height: 14px;margin-top:5px;">
        </div>
    </div>
</script>

<script type="text/x-red" data-help-name="NICP-facebook-node">
    <p>
        設置Facebook Messenger Webhook驗證的資料
    </p>
    <h3>Details</h3>
    <dl class="message-properties">
        <dt>Bot-Name</dt>
        <dd>您要給這個機器人(粉絲專頁)的名稱</dd>
        <dt>Token</dt>
        <dd>Token必須從Facebook開發者頁面取得。取得步驟為：
            <ul>
                <li>至您在Facebook開發者頁面創造的Facebook App</li>
                <li>至左邊列表的PRODUCTS的Messenger的Settings</li>
                <li>在Token Generation部分中的Page選擇您要連結的APP</li>
                <li>Page Access Token將會產生Token</li>
            </ul>
        </dd>
        <dt>App Secret(非必填)</dt>
        <dd>App Secret也是須從Facebook開發者頁面取得。取得步驟為：
            <ul>
                <li>至您在Facebook開發者頁面創造的Facebook App</li>
                <li>至左邊列表的Settings的Basic</li>
                <li>App Secret通常位於App ID的右邊，它會以密碼的形式呈現。點擊Show，您需輸入您的Facebook密碼來取得他</li>
            </ul>
        </dd>
        <dt>Verify</dt>
        <dd>Verify為您自定義的驗證碼，通常會定義一串字串，它將被作為Facebook平台對您的Webhook做的一的驗證手段。您需至Facebook開發者頁面的Webhook頁面放置此驗證碼，Webhook頁面位於：
            <ul>
                <li>Facebook開發者頁面創造的Facebook App</li>
                <li>至左邊列表的PRODUCTS的Messenger的Webhooks</li>
                <li>於上方下拉選單選擇Page(通常預設就是Page)，點擊Edit Subscription</li>
                <li>於彈出的視窗中下方的Verify Token欄位填寫您自定義的驗證碼</li>
            </ul>
            驗證碼填寫完畢記得同時設置Callback URL
        </dd>
        <dt>Webhook URL</dt>
        <dd>Webhook URL為您自定義的Webhook Service URL的後綴，填寫格式為/${urlname}，範例：/phonebot，設置完畢後，FCF會幫您啟動一個Webhook Service，
            完整URL為http://localhost:1880/nicp/facebook/phonebot(此完整URL僅供參考，Facebook平台規定Webhook需為公開網址且要有Https，請自行架設)
            ，這段完整URL填寫的位置和Verify驗證碼設置的位置一樣，請將它設置在Verify Token上面那個Callback URL欄位中，而Callback URL欄位的位置請參考上述Verify的說明。
        </dd>
    </dl>
</script>
<!--NICP-facebook-node結束-->


<script type="text/javascript">//Facebook In開始
    RED.nodes.registerType("NICP-facebook-receive", {
        category: "NICP",
        color: "#FFCC66",
        defaults: {
            name: {
                value: "",
            },
            bot: {//此物件存的是facebook的設置節點(就是在config頁籤的節點)的Node的ID，所以最後存的是像這樣的字串:98bd3fe8.c4eb5
                value: "",
                type: "NICP-facebook-node",
                required: true
            }
        },
        inputs: 0,
        outputs: 1,
        icon: "chatbot-receiver.png",
        paletteLabel: "Facebook In",
        label: function () {
            let labelName = "Facebook In";
            if (this.name) {
                return `${labelName} : ${this.name}`;
            }
            else {
                return labelName;
            }
        }
    });

</script>

<script type="text/x-red" data-template-name="NICP-facebook-receive"><!-- Facebook In第二部分 -->
    <div class="form-row">
        <!-- 節點名稱 -->
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-bot"><i class="icon-bookmark"></i> Bot</label>
        <input type="text" id="node-input-bot" placeholder="Bot">
    </div>
</script>

<script type="text/x-red" data-help-name="NICP-facebook-receive">
  <p>
    用來接收從 Facebook 通訊平台送來的訊息
  </p>
</script>
<!-- Facebook In結束 -->

<script type="text/javascript">//Facebook Out開始
    let locale = [
        "default",
        "en_US",
        "ca_ES",
        "cs_CZ",
        "cx_PH",
        "cy_GB",
        "da_DK",
        "de_DE",
        "eu_ES",
        "en_UD",
        "es_LA",
        "es_ES",
        "gn_PY",
        "fi_FI",
        "fr_FR",
        "gl_ES",
        "hu_HU",
        "it_IT",
        "ja_JP",
        "ko_KR",
        "nb_NO",
        "nn_NO",
        "nl_NL",
        "fy_NL",
        "pl_PL",
        "pt_BR",
        "pt_PT",
        "ro_RO",
        "ru_RU",
        "sk_SK",
        "sl_SI",
        "sv_SE",
        "th_TH",
        "tr_TR",
        "ku_TR",
        "zh_CN",
        "zh_HK",
        "zh_TW",
        "af_ZA",
        "sq_AL",
        "hy_AM",
        "az_AZ",
        "be_BY",
        "bn_IN",
        "bs_BA",
        "bg_BG",
        "hr_HR",
        "nl_BE",
        "en_GB",
        "et_EE",
        "fo_FO",
        "fr_CA",
        "ka_GE",
        "el_GR",
        "gu_IN",
        "hi_IN",
        "is_IS",
        "id_ID",
        "ga_IE",
        "jv_ID",
        "kn_IN",
        "kk_KZ",
        "lv_LV",
        "lt_LT",
        "mk_MK",
        "mg_MG",
        "ms_MY",
        "mt_MT",
        "mr_IN",
        "mn_MN",
        "ne_NP",
        "pa_IN",
        "sr_RS",
        "so_SO",
        "sw_KE",
        "tl_PH",
        "ta_IN",
        "te_IN",
        "ml_IN",
        "uk_UA",
        "uz_UZ",
        "vi_VN",
        "km_KH",
        "tg_TJ",
        "ar_AR",
        "he_IL",
        "ur_PK",
        "fa_IR",
        "ps_AF",
        "my_MM",
        "qz_MM",
        "or_IN",
        "si_LK",
        "rw_RW",
        "cb_IQ",
        "ha_NG",
        "ja_KS",
        "br_FR",
        "tz_MA",
        "co_FR",
        "as_IN",
        "ff_NG",
        "sc_IT",
        "sz_PL"
    ];
    RED.nodes.registerType("NICP-facebook-send", {
        category: "NICP",
        color: "#FFCC66",
        defaults: {
            name: {
                value: ""
            },
            bot: {
                value: "",
                type: "NICP-facebook-node",
                required: true
            },
            track: {
                value: false
            },
            outputs: {
                value: 0
            },
            fcfFacebookRoleNode: {
                value: "",
                type: "NICP-facebook-config-role",
                required: false
            },
            mode: {
                value: "message"
            },
            startedButtonPostbackPayload: {
                value: "",
            },
            greetings: {
                value: [{
                    locale: "default",
                    text: "Hi,Xanxus"
                }]
            }
        },
        inputs: 1,
        outputs: 0,
        icon: "chatbot-sender.png",
        paletteLabel: "Facebook Out",
        label: function () {
            let labelName = "Facebook Out";
            if (this.name) {
                return `${labelName} : ${this.name}`;
            }
            else {
                return labelName;
            }
        },
        oneditprepare: function () { //當使用者打開此節點的Edit dialog畫面時要做的事
            let node = this;
            $("#node-input-rule-container").css("min-height", "300px").css("min-width", "450px").editableList({
                addItem: function (container, i, _greetings) {
                    if (!_greetings.hasOwnProperty("locale")) {
                        _greetings.locale = "default";
                        _greetings.text = "Hello!";
                    }
                    let localeSelectField = $("<select/>", { class: "node-input-locale", style: "width:110px; margin-right:10px;" }).appendTo(container);
                    let selectOptions = [];
                    for (let i = 0; i < locale.length; i++) {
                        selectOptions.push({
                            value: locale[i],
                            text: locale[i]
                        });
                    }
                    for (let i = 0; i < selectOptions.length; i++) {
                        localeSelectField.append($("<option></option>").val(selectOptions[i].value).text(selectOptions[i].text));
                    }
                    let propertyValue2 = $("<input/>", { class: "node-input-text", type: "text", value: _greetings.text })
                        .appendTo(container);

                    localeSelectField.val(_greetings.locale);

                },
                removable: true,
                sortable: true
            })
            for (let i = 0; i < node.greetings.length; i++) {
                $("#node-input-rule-container").editableList("addItem", node.greetings[i]);
            }

            //切換模式，看是要輸出訊息還是設置開始使用
            $("#node-input-mode").change(function () {
                const value = $(this).val();
                if (value === "message") {
                    $(".cMessage").show();
                    $(".cWelcomeScreen").hide();
                    $(".node-input-rule-container-row").hide();
                }
                else {
                    $(".cMessage").hide();
                    $(".cWelcomeScreen").show();
                    $(".node-input-rule-container-row").show();
                }
            });
            $("#node-input-mode").change();// 先呼叫一次，這樣第一次打開才會有效果，不然還要手動再選一次才有效果
        },
        oneditsave: function () {
            let track = $("#node-input-track").is(":checked");
            this.outputs = track ? 1 : 0;

            let node = this;
            let items = $("#node-input-rule-container").editableList("items");
            node.greetings = [];//這你一定要創造一個node.greetings，跟上面定義的屬性名稱要一樣，這樣才存得進去
            items.each(function (i) {
                let data = $(this);
                node.greetings.push({
                    locale: data.find(".node-input-locale").val(),//這裡的locale和text也是和上面定義的屬性要一樣
                    text: data.find(".node-input-text").val()
                });
            });
        }
    });

</script>

<script type="text/x-red" data-template-name="NICP-facebook-send"><!-- Facebook Out第二部分 -->
    <div class="form-row">
        <!-- 節點名稱 -->
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-bot"><i class="icon-bookmark"></i> Bot</label>
        <input type="text" id="node-input-bot" placeholder="Bot">
    </div>
    <!-- 設置模式表單，看是要當作一般Facebook Out輸出訊息，還是要設置開始使用-->
    <div class="form-row">
        <label for="node-input-mode"><i class="icon-bookmark"></i> Mode</label>
        <select id="node-input-mode">
            <!-- 一般Facebook Out輸出訊息 -->
            <option value="message">Message</option>
            <!-- 設置開始使用 -->
            <option value="welcomeScreen">Welcome Screen</option>
        </select>
    </div>
    <div class="form-row cMessage">
        <label for="node-input-fcfFacebookRoleNode"><i class="icon-bookmark"></i> Role</label>
        <input type="text" id="node-input-fcfFacebookRoleNode">
    </div>
    <div class="form-row cMessage">
        <label for="node-input-track"><i class="icon-envelope"></i> Track Conversation</label>
        <input type="checkbox" value="true" id="node-input-track">
        <div style="max-width: 460px;font-size: 12px;color: #999999;line-height: 14px;margin-top:5px;">
        </div>
    </div>
    <!-- 開始使用按鈕的字串 -->
    <div class="form-row cWelcomeScreen">
        <label for="node-input-startedButtonPostbackPayload"><i class="icon-tag"></i> Postback Payload</label>
        <input type="text" id="node-input-startedButtonPostbackPayload" placeholder="e.g. welcome">
    </div>
    <!-- 定義裝表單項目的容器 -->
    <div class="form-row node-input-rule-container-row">
        <ol id="node-input-rule-container"></ol>
    </div>
</script>

<script type="text/x-red" data-help-name="NICP-facebook-send">
    <p>
        用來將訊息傳送至 Facebook 通訊平台
    </p>
</script>
<!-- Facebook Out結束 -->

<!-- 設置角色的節點 -->
<script type="text/javascript">
    RED.nodes.registerType("NICP-facebook-config-role", {
        category: "config",
        defaults: {
            name: {
                value: "",
                required: true
            }
        },
        credentials: {
            targetUserID: {
                type: "text"
            }
        },
        //定義這個config形式的節點在別的節點的dialog所呈現的字串，和在右邊的config sidebar所呈現的字串
        label: function () {
            return this.name || "NICP-facebook-config-role";
        }
    });
</script>

<script type="text/x-red" data-template-name="NICP-facebook-config-role">
    <!-- 注意這裡的id是node-config-input-開頭 -->
        <!-- 定義這個credential節點的名稱 -->
    <div class="form-row">
        <label for="node-config-input-name"><i class="icon-bookmark"></i> Name</label>
        <input type="text" id="node-config-input-name">
    </div>
        <!-- 定義使用者名稱的表單 -->
    <div class="form-row">
        <label for="node-config-input-targetUserID"><i class="icon-bookmark"></i> Target UserID</label>
        <input type="text" id="node-config-input-targetUserID">
    </div>
</script>