<!--這幾個新節點的色票 https://coolors.co/479b4d-ffea32-ff9f4c-ce5eed-5998ff -->
<script type="text/x-red" data-template-name="FCF-Transformation">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <!-- Context List清單 -->
    <div class="form-row">
        <label for="results"><i class="fa fa-list-ol"></i> <span>Context List</span></label>
        <ol id="results">
        </ol>
    </div>
    <!-- 沒有這個表單似乎沒影響 -->
    <div class="form-row" style="margin-bottom:0;">
        <label><i class="fa fa-list"></i> <span data-i18n="change.label.rules"></   ></label>
    </div>
    <div class="form-row node-input-rule-container-row">
        <ol id="node-input-rule-container"></ol>
    </div>
</script>

<script type="text/x-red" data-help-name="FCF-Transformation">
    <p>Set, change, delete or move properties of a message, flow context or global context.</p>
    <p>The node can specify multiple rules that will be applied in the order they are defined.</p>
    <h3>Details</h3>
    <p>The available operations are:</p>
    <dl class="message-properties">
    <dt>Set</dt>
    <dd>set a property. The value can be a variety of different types, or
            can be taken from an existing message or context property.</dd>
    <dt>Change</dt>
    <dd>search &amp; replace parts of the property. If regular expressions
        are enabled, the "replace with" property can include capture groups, for
        example <code>$1</code>. Replace will only change the type if there
        is a complete match.</dd>
    <dt>Delete</dt>
    <dd>delete a property.</dd>
    <dt>Move</dt>
    <dd>move or rename a property.</dd>
    </dl>
</script>

<script type="text/javascript">
    RED.nodes.registerType("FCF-Transformation", {
        color: "#FFEA32",
        category: "FCF",
        defaults: {
            name: {
                value: ""
            },
            rules: {
                value: [{
                    t: "set",
                    p: "payload",
                    pt: "msg",
                    to: "",
                    tot: "str"
                }]
            },
            // legacy
            action: {
                value: ""
            },
            property: {
                value: ""
            },
            from: {
                value: ""
            },
            to: {
                value: ""
            },
            reg: {
                value: false
            }
        },
        inputs: 1,
        outputs: 1,
        paletteLabel: "Transformation",
        icon: "swap.png",
        label: function () {
            function prop2name(type, key) {
                let result = RED.utils.parseContextKey(key);
                return type + "." + result.key;
            }
            if (this.name) {
                return this.name;
            }
            if (!this.rules) {
                if (this.action === "replace") {
                    return this._("change.label.set", { property: "msg." + this.property });
                } else if (this.action === "change") {
                    return this._("change.label.change", { property: "msg." + this.property });
                } else if (this.action === "move") {
                    return this._("change.label.move", { property: "msg." + this.property });
                } else {
                    return this._("change.label.delete", { property: "msg." + this.property });
                }
            } else {
                //當此節點拉出來時，這裡會呼叫兩次！
                if (this.rules.length == 1) {
                    if (this.rules[0].t === "set") {
                        //下面這行會回傳類似set msg.payload這樣的字串
                        return this._("change.label.set", { property: prop2name((this.rules[0].pt || "msg"), this.rules[0].p) });
                    } else if (this.rules[0].t === "change") {
                        return this._("change.label.change", { property: prop2name((this.rules[0].pt || "msg"), this.rules[0].p) });
                    } else if (this.rules[0].t === "move") {
                        return this._("change.label.move", { property: prop2name((this.rules[0].pt || "msg"), this.rules[0].p) });
                    } else {
                        return this._("change.label.delete", { property: prop2name((this.rules[0].pt || "msg"), this.rules[0].p) });
                    }
                } else {
                    return this._("change.label.changeCount", { count: this.rules.length });
                }
            }
        },
        labelStyle: function () {
            return this.name ? "node_label_italic" : "Xanxus";
        },
        oneditprepare: function () {

            let node = this;
            let set = this._("change.action.set");//此set用typeof set看，是字串型態，印出"Set"
            let change = this._("change.action.change");
            let del = this._("change.action.delete");
            let move = this._("change.action.move");
            let to = this._("change.action.to");
            let search = this._("change.action.search");
            let replace = this._("change.action.replace");
            let regex = this._("change.label.regex");

            function resizeRule(rule) {
                let newWidth = rule.width();
                rule.find(".red-ui-typedInput").typedInput("width", newWidth - 240);
            }

            function getContextKeys(data, contextType) {
                let sortedData = {};
                for (let store in data) {
                    if (data.hasOwnProperty(store)) {
                        for (let key in data[store]) {
                            if (data[store].hasOwnProperty(key)) {
                                if (!sortedData.hasOwnProperty(key)) {
                                    sortedData[key] = [];
                                }
                                data[store][key].store = store;
                                sortedData[key].push(data[store][key])
                            }
                        }
                    }
                }
                let keys = Object.keys(sortedData);
                keys.sort();
                let contextObject = [];//存放flow.www or global.ccc這樣的東西
                for (let i = 0; i < keys.length; i++) {
                    contextObject.push(contextType + "." + keys[i]);
                }
                return contextObject;
            }

            // let texts = [];
            // $("#results .searchterm").each(function () {
            //     texts.push($(this).text());
            // });

            $.when(
                $.getJSON(`context/flow/${this.z}`),
                $.getJSON(`context/global`)
				/*
				data1(Array):
					0: {memory: {…}}
					1: "success"
					2:
						abort: ƒ (a)
						always: ƒ ()
						complete: ƒ ()
						done: ƒ ()
						error: ƒ ()
						fail: ƒ ()
						getAllResponseHeaders: ƒ ()
						getResponseHeader: ƒ (a)
						overrideMimeType: ƒ (a)
						pipe: ƒ ()
						progress: ƒ ()
						promise: ƒ (a)
						readyState: 4
						responseJSON: {memory: {…}}
						responseText: "{"memory":{"aaa":{"msg":"123","format":"string[3]"}}}"
						setRequestHeader: ƒ (a,b)
						state: ƒ ()
						status: 200
						statusCode: ƒ (a)
						statusText: "OK"
						success: ƒ ()
						then: ƒ ()
				*/
            ).then(function (data1, data2) {
                let contextFlowObject = getContextKeys(data1[0], "flow");//回傳型態是Array
                let contextGlobalObject = getContextKeys(data2[0], "global");
                let contextObjectArray = contextFlowObject.concat(contextGlobalObject);
                window.contextObjectArray = contextObjectArray;
                for (let i = 0; i < contextObjectArray.length; i++) {
                    let spanTag = $("<apan/>", {
                        "class": "searchterm",
                        "text": contextObjectArray[i],
                    });
                    let liTag = $("<li/>", {
                        "class": "propertyli"
                    });
                    $(liTag).append(spanTag).appendTo("#results");
                }
            }).fail(function (problem) {
                console.log(problem);
            });
            $("#node-input-rule-container").css("min-height", "300px").css("min-width", "450px").editableList({
                //當加入新項目時，會呼叫的方法
                //i:如果目前已經存在3個項目，addItem似乎會呼叫3次，每次i會加1，所以有三個i會是0~2
                //opt:這個項目儲存的物件，{t: "set", p: "payload", pt: "msg", to: "", tot: "str"}
                addItem: function (container, i, opt) {
                    let rule = opt;
                    // 讓當加入新項目時，表單會有初始值
                    if (!rule.hasOwnProperty("t")) {
                        rule = { t: "set", p: "payload", to: "", tot: "str" };
                    }
                    if (rule.t === "change" && rule.re) {
                        rule.fromt = "re";
                        delete rule.re;
                    }
                    if (rule.t === "set" && !rule.tot) {
                        if (rule.to.indexOf("msg.") === 0 && !rule.tot) {
                            rule.to = rule.to.substring(4);
                            rule.tot = "msg";
                        } else {
                            rule.tot = "str";
                        }
                    }
                    if (rule.t === "move" && !rule.tot) {
                        rule.tot = "msg";
                    }
                    container.css({
                        overflow: "hidden",
                        whiteSpace: "nowrap"
                    });

                    let row1 = $("<div/>").appendTo(container);
                    let row2 = $("<div/>", { style: "margin-top:8px;" }).appendTo(container);
                    let row3 = $("<div/>", { style: "margin-top:8px;" }).appendTo(container);
                    let row4 = $("<div/>", { style: "margin-top:8px;" }).appendTo(container);

                    // 定義set change del move表單元件
                    let selectField = $("<select/>", { class: "node-input-rule-type", style: "width:110px; margin-right:10px;" }).appendTo(row1);
                    let selectOptions = [{
                        v: "set",
                        l: set
                    },
                    {
                        v: "change",
                        l: change
                    },
                    {
                        v: "delete",
                        l: del
                    },
                    {
                        v: "move",
                        l: move
                    }];
                    for (let i = 0; i < 4; i++) {
                        selectField.append($("<option></option>").val(selectOptions[i].v).text(selectOptions[i].l));
                    }

                    //定義第一列右邊的下拉選單(屬性名稱)msg,flow,global
                    let propertyName = $("<input/>", { class: "node-input-rule-property-name", type: "text" })
                        .appendTo(row1)
                        .typedInput({ types: ["msg", "flow", "global"] });
                    let selectContextNumber = $("<select/>", { class: "selectNumber1", style: "width:35px;" }).appendTo(row1);
                    // 動態生成option
                    let selectOptions2 = [];
                    if (!window.contextObjectArray) {
                        window.contextObjectArray = [];
                    }
                    for (let i = 0; i < window.contextObjectArray.length; i++) {
                        let value = (i + 1).toString();
                        let optionObject = {
                            v: value,
                            l: value
                        }
                        selectOptions2.push(optionObject);
                    }
                    selectContextNumber.append($("<option/>", { selected: true, disabled: "disabled", text: "--" }));
                    for (let i = 0; i < selectOptions2.length; i++) {
                        selectContextNumber.append($("<option></option>").val(selectOptions2[i].v).text(selectOptions2[i].l));
                    }

                    //這個div是set選項的to區塊
                    $("<div/>", { style: "display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;" })
                        .text(to)
                        .appendTo(row2);
                    //定義第一列右邊的輸入表單(屬性的值)msg, flow, global, str, num, bool, json, bin, date, jsonata, env
                    let propertyValue = $("<input/>", { class: "node-input-rule-property-value", type: "text" })
                        .appendTo(row2)
                        .typedInput({ default: "str", types: ["msg", "flow", "global", "str", "num", "bool", "json"] });
                    let selectContextNumber2 = $("<select/>", { class: "selectNumber2", style: "width:35px;" }).appendTo(row2);
                    selectContextNumber2.append($("<option/>", { selected: true, disabled: "disabled", text: "--" }));
                    for (let i = 0; i < selectOptions2.length; i++) {
                        selectContextNumber2.append($("<option></option>").val(selectOptions2[i].v).text(selectOptions2[i].l));
                    }

                    let row3_1 = $("<div/>").appendTo(row3);
                    //這個div是change選項的Search for區塊
                    $("<div/>", { style: "display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;" })
                        .text(search)
                        .appendTo(row3_1);
                    //定義change選項的搜尋欄位的下拉選單的值
                    let fromValue = $("<input/>", { class: "node-input-rule-property-search-value", type: "text" })
                        .appendTo(row3_1)
                        .typedInput({ default: "str", types: ["msg", "flow", "global", "str", "num", "bool"] });
                    let selectContextNumber3_1 = $("<select/>", { class: "selectNumber3_1", style: "width:35px;" }).appendTo(row3_1);
                    selectContextNumber3_1.append($("<option/>", { selected: true, disabled: "disabled", text: "--" }));
                    for (let i = 0; i < selectOptions2.length; i++) {
                        selectContextNumber3_1.append($("<option></option>").val(selectOptions2[i].v).text(selectOptions2[i].l));
                    }

                    let row3_2 = $("<div/>", { style: "margin-top:8px;" }).appendTo(row3);
                    //這個div是change選項的Replace with區塊
                    $("<div/>", { style: "display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;" })
                        .text(replace)
                        .appendTo(row3_2);
                    //定義change選項的Replace with區塊的下拉選單的值
                    let toValue = $("<input/>", { class: "node-input-rule-property-replace-value", type: "text" })
                        .appendTo(row3_2)
                        .typedInput({ default: "str", types: ["msg", "flow", "global", "str", "num", "bool", "json"] });
                    let selectContextNumber3_2 = $("<select/>", { class: "selectNumber3_2", style: "width:35px;" }).appendTo(row3_2);
                    selectContextNumber3_2.append($("<option/>", { selected: true, disabled: "disabled", text: "--" }));
                    for (let i = 0; i < selectOptions2.length; i++) {
                        selectContextNumber3_2.append($("<option></option>").val(selectOptions2[i].v).text(selectOptions2[i].l));
                    }

                    //這個div是move選項的to區塊
                    $("<div/>", { style: "display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;" })
                        .text(to)
                        .appendTo(row4);
                    // 定義move選項的第二列的下拉選單的屬性名
                    let moveValue = $("<input/>", { class: "node-input-rule-property-move-value", type: "text" })
                        .appendTo(row4)
                        .typedInput({ default: "msg", types: ["msg", "flow", "global"] });
                    let selectContextNumber4 = $("<select/>", { class: "selectNumber4", style: "width:35px;" }).appendTo(row4);
                    selectContextNumber4.append($("<option/>", { selected: true, disabled: "disabled", text: "--" }));
                    for (let i = 0; i < selectOptions2.length; i++) {
                        selectContextNumber4.append($("<option></option>").val(selectOptions2[i].v).text(selectOptions2[i].l));
                    }

                    selectField.change(function () {
                        let width = $("#node-input-rule-container").width();
                        //$(this).val()會印出set或change或delete或move
                        let type = $(this).val();
                        if (type == "set") {
                            row2.show();
                            row3.hide();
                            row4.hide();
                        } else if (type == "change") {
                            row2.hide();
                            row3.show();
                            row4.hide();
                        } else if (type == "delete") {
                            row2.hide();
                            row3.hide();
                            row4.hide();
                        } else if (type == "move") {
                            row2.hide();
                            row3.hide();
                            row4.show();
                        }
                        resizeRule(container);
                    });

                    $(".selectNumber1").on("change", function () {
                        let index = this.value - 1;
                        let objPropertyArray = getSplitObjProperty(window.contextObjectArray[index]);
                        propertyName.typedInput("type", objPropertyArray[0]);
                        propertyName.typedInput("value", objPropertyArray[1]);
                    });
                    $(".selectNumber2").on("change", function () {
                        let index = this.value - 1;
                        let objPropertyArray = getSplitObjProperty(window.contextObjectArray[index]);
                        propertyValue.typedInput("type", objPropertyArray[0]);
                        propertyValue.typedInput("value", objPropertyArray[1]);
                    });
                    $(".selectNumber3_1").on("change", function () {
                        let index = this.value - 1;
                        let objPropertyArray = getSplitObjProperty(window.contextObjectArray[index]);
                        fromValue.typedInput("type", objPropertyArray[0]);
                        fromValue.typedInput("value", objPropertyArray[1]);
                    });
                    $(".selectNumber3_2").on("change", function () {
                        let index = this.value - 1;
                        let objPropertyArray = getSplitObjProperty(window.contextObjectArray[index]);
                        toValue.typedInput("type", objPropertyArray[0]);
                        toValue.typedInput("value", objPropertyArray[1]);
                    });
                    $(".selectNumber4").on("change", function () {
                        let index = this.value - 1;
                        let objPropertyArray = getSplitObjProperty(window.contextObjectArray[index]);
                        moveValue.typedInput("type", objPropertyArray[0]);
                        moveValue.typedInput("value", objPropertyArray[1]);
                    });

                    //把於defaults物件裡的那些屬性的值，設定進這些表單元件，也就是在做設定初始預設值的動作
                    //經測試，把以下幾行拿掉，即使不手動設定節點，於上面定義的預設值還是可以傳到js那邊
                    selectField.val(rule.t);
                    propertyName.typedInput("value", rule.p);
                    propertyName.typedInput("type", rule.pt);
                    propertyValue.typedInput("value", rule.to);
                    propertyValue.typedInput("type", rule.tot);
                    moveValue.typedInput("value", rule.to);
                    moveValue.typedInput("type", rule.tot);
                    fromValue.typedInput("value", rule.from);
                    fromValue.typedInput("type", rule.fromt);
                    toValue.typedInput("value", rule.to);
                    toValue.typedInput("type", rule.tot);

                    selectField.change();

                    let newWidth = $("#node-input-rule-container").width();
                    resizeRule(container);
                },
                resizeItem: resizeRule,
                removable: true,
                sortable: true
            });
            //當此節點一拉出來時，this.rules.length就是1了
            for (let i = 0; i < this.rules.length; i++) {
                let rule = this.rules[i];
                $("#node-input-rule-container").editableList("addItem", rule);
            }
            function getSplitObjProperty(objProperty) {
                let objPropertyArray = [];
                objPropertyArray = objProperty.split(".");
                for (let i = 0; i < objPropertyArray.length; i++) {
                    objPropertyArray[i] = objPropertyArray[i].trim();
                }
                return objPropertyArray;
            }
        },
        //此方法除了定義當儲存時要做的事，還有把item表單保存起來，這樣下次打開才會有上次輸入的東西
        oneditsave: function () {
            let rules = $("#node-input-rule-container").editableList("items");
            let node = this;
            node.rules = [];
            rules.each(function (i) {
                let rule = $(this);
                let type = rule.find(".node-input-rule-type").val();
                let r = {
                    t: type,
                    p: rule.find(".node-input-rule-property-name").typedInput("value"),
                    pt: rule.find(".node-input-rule-property-name").typedInput("type")
                };
                if (type === "set") {
                    r.to = rule.find(".node-input-rule-property-value").typedInput("value");
                    r.tot = rule.find(".node-input-rule-property-value").typedInput("type");
                } else if (type === "move") {
                    r.to = rule.find(".node-input-rule-property-move-value").typedInput("value");
                    r.tot = rule.find(".node-input-rule-property-move-value").typedInput("type");
                } else if (type === "change") {
                    r.from = rule.find(".node-input-rule-property-search-value").typedInput("value");
                    r.fromt = rule.find(".node-input-rule-property-search-value").typedInput("type");
                    r.to = rule.find(".node-input-rule-property-replace-value").typedInput("value");
                    r.tot = rule.find(".node-input-rule-property-replace-value").typedInput("type");
                }
                node.rules.push(r);
            });
        },
        oneditresize: function (size) {
            let rows = $("#dialog-form>div:not(.node-input-rule-container-row)");
            let height = size.height;
            for (let i = 0; i < rows.size(); i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            let editorRow = $("#dialog-form>div.node-input-rule-container-row");
            height -= (parseInt(editorRow.css("marginTop")) + parseInt(editorRow.css("marginBottom")));

            $("#node-input-rule-container").editableList("height", height);
        }
    });
</script>