<!--這幾個新節點的色票 https://coolors.co/479b4d-ffea32-ff9f4c-ce5eed-5998ff -->
<script type="text/x-red" data-template-name="FCF-Transformation">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <!-- 沒有這個表單似乎沒影響 -->
    <div class="form-row" style="margin-bottom:0;">
        <label><i class="fa fa-list"></i> <span data-i18n="change.label.rules"></   ></label>
    </div>
    <div class="form-row node-input-rule-container-row">
        <ol id="node-input-rule-container"></ol>
    </div>
</script>

<script type="text/x-red" data-help-name="FCF-Transformation">
    <p>Set, change, delete or move properties of a message, flow context or global context.</p>
    <p>The node can specify multiple rules that will be applied in the order they are defined.</p>
    <h3>Details</h3>
    <p>The available operations are:</p>
    <dl class="message-properties">
    <dt>Set</dt>
    <dd>set a property. The value can be a variety of different types, or
            can be taken from an existing message or context property.</dd>
    <dt>Change</dt>
    <dd>search &amp; replace parts of the property. If regular expressions
        are enabled, the "replace with" property can include capture groups, for
        example <code>$1</code>. Replace will only change the type if there
        is a complete match.</dd>
    <dt>Delete</dt>
    <dd>delete a property.</dd>
    <dt>Move</dt>
    <dd>move or rename a property.</dd>
    </dl>
    <p>The "expression" type uses the <a href="http://jsonata.org/" target="_new">JSONata</a>
    query and expression language.
    </p>
</script>

<script type="text/javascript">
    RED.nodes.registerType("FCF-Transformation", {
        color: "#FFEA32",
        category: "FCF",
        defaults: {
            name: {
                value: ""
            },
            rules: {
                value: [{
                    t: "set",
                    p: "payload",
                    pt: "msg",
                    to: "",
                    tot: "str"
                }]
            },
            // legacy
            action: {
                value: ""
            },
            property: {
                value: ""
            },
            from: {
                value: ""
            },
            to: {
                value: ""
            },
            reg: {
                value: false
            }
        },
        inputs: 1,
        outputs: 1,
        paletteLabel: "Transformation",
        icon: "swap.png",
        label: function () {
            function prop2name(type, key) {
                let result = RED.utils.parseContextKey(key);
                return type + "." + result.key;
            }
            if (this.name) {
                return this.name;
            }
            if (!this.rules) {
                if (this.action === "replace") {
                    return this._("change.label.set", { property: "msg." + this.property });
                } else if (this.action === "change") {
                    return this._("change.label.change", { property: "msg." + this.property });
                } else if (this.action === "move") {
                    return this._("change.label.move", { property: "msg." + this.property });
                } else {
                    return this._("change.label.delete", { property: "msg." + this.property });
                }
            } else {
                if (this.rules.length == 1) {
                    if (this.rules[0].t === "set") {
                        return this._("change.label.set", { property: prop2name((this.rules[0].pt || "msg"), this.rules[0].p) });
                    } else if (this.rules[0].t === "change") {
                        return this._("change.label.change", { property: prop2name((this.rules[0].pt || "msg"), this.rules[0].p) });
                    } else if (this.rules[0].t === "move") {
                        return this._("change.label.move", { property: prop2name((this.rules[0].pt || "msg"), this.rules[0].p) });
                    } else {
                        return this._("change.label.delete", { property: prop2name((this.rules[0].pt || "msg"), this.rules[0].p) });
                    }
                } else {
                    return this._("change.label.changeCount", { count: this.rules.length });
                }
            }
        },
        labelStyle: function () {
            return this.name ? "node_label_italic" : "Xanxus";
        },
        oneditprepare: function () {
            let node = this;
            let set = this._("change.action.set");
            let change = this._("change.action.change");
            let del = this._("change.action.delete");
            let move = this._("change.action.move");
            let to = this._("change.action.to");
            let search = this._("change.action.search");
            let replace = this._("change.action.replace");
            let regex = this._("change.label.regex");

            function resizeRule(rule) {
                let newWidth = rule.width();
                rule.find(".red-ui-typedInput").typedInput("width", newWidth - 130);

            }
            $("#node-input-rule-container").css("min-height", "300px").css("min-width", "450px").editableList({
                addItem: function (container, i, opt) {
                    let rule = opt;
                    //設定，當節點一開始拉出來時，他的預設值
                    if (!rule.hasOwnProperty("t")) {
                        rule = { t: "set", p: "payload", to: "", tot: "str" };
                    }
                    if (rule.t === "change" && rule.re) {
                        rule.fromt = "re";
                        delete rule.re;
                    }
                    if (rule.t === "set" && !rule.tot) {
                        if (rule.to.indexOf("msg.") === 0 && !rule.tot) {
                            rule.to = rule.to.substring(4);
                            rule.tot = "msg";
                        } else {
                            rule.tot = "str";
                        }
                    }
                    if (rule.t === "move" && !rule.tot) {
                        rule.tot = "msg";
                    }
                    container.css({
                        overflow: "hidden",
                        whiteSpace: "nowrap"
                    });
                    let row1 = $("<div/>").appendTo(container);
                    let row2 = $("<div/>", { style: "margin-top:8px;" }).appendTo(container);
                    let row3 = $("<div/>", { style: "margin-top:8px;" }).appendTo(container);
                    let row4 = $("<div/>", { style: "margin-top:8px;" }).appendTo(container);

                    //定義set change del move表單元件
                    let selectField = $("<select/>", { class: "node-input-rule-type", style: "width:110px; margin-right:10px;" }).appendTo(row1);
                    let selectOptions = [{
                        v: "set",
                        l: set
                    },
                    {
                        v: "change",
                        l: change
                    },
                    {
                        v: "delete",
                        l: del
                    },
                    {
                        v: "move",
                        l: move
                    }];

                    for (let i = 0; i < 4; i++) {
                        selectField.append($("<option></option>").val(selectOptions[i].v).text(selectOptions[i].l));
                    }

                    //定義第一列右邊的下拉選單(屬性名稱)msg,flow,global
                    let propertyName = $("<input/>", { class: "node-input-rule-property-name", type: "text" })
                        .appendTo(row1)
                        .typedInput({ types: ["msg", "flow", "global"] });
                    //這個div是set選項的to區塊
                    $("<div/>", { style: "display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;" })
                        .text(to)
                        .appendTo(row2);
                    //定義第一列右邊的輸入表單(屬性的值)msg, flow, global, str, num, bool, json, bin, date, jsonata, env
                    let propertyValue = $("<input/>", { class: "node-input-rule-property-value", type: "text" })
                        .appendTo(row2)
                        .typedInput({ default: "str", types: ["msg", "flow", "global", "str", "num", "bool", "json", "bin", "date", "jsonata", "env"] });

                    let row3_1 = $("<div/>").appendTo(row3);
                    //這個div是change選項的Search for區塊
                    $("<div/>", { style: "display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box; background-color:rgb(84, 233, 15);" })
                        .text(search)
                        .appendTo(row3_1);
                    //定義change選項的搜尋欄位的下拉選單的值
                    let fromValue = $("<input/>", { class: "node-input-rule-property-search-value", type: "text" })
                        .appendTo(row3_1)
                        .typedInput({ default: "str", types: ["msg", "flow", "global", "str", "re", "num", "bool", "env"] });

                    let row3_2 = $("<div/>", { style: "margin-top:8px;" }).appendTo(row3);
                    //這個div是change選項的Replace with區塊
                    $("<div/>", { style: "display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box; background-color:rgb(9, 139, 245);" })
                        .text(replace)
                        .appendTo(row3_2);
                    //定義change選項的Replace with區塊的下拉選單的值
                    let toValue = $("<input/>", { class: "node-input-rule-property-replace-value", type: "text" })
                        .appendTo(row3_2)
                        .typedInput({ default: "str", types: ["msg", "flow", "global", "str", "num", "bool", "json", "bin", "env"] });
                    //這個div是move選項的to區塊
                    $("<div/>", { style: "display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;background-color:rgb(155, 23, 167);" })
                        .text(to)
                        .appendTo(row4);
                    // 定義move選項的第二列的下拉選單的屬性名
                    let moveValue = $("<input/>", { class: "node-input-rule-property-move-value", type: "text" })
                        .appendTo(row4)
                        .typedInput({ default: "msg", types: ["msg", "flow", "global"] });

                    selectField.change(function () {
                        let width = $("#node-input-rule-container").width();
                        //$(this).val()會印出set或change或delete或move
                        let type = $(this).val();
                        if (type == "set") {
                            row2.show();
                            row3.hide();
                            row4.hide();
                        } else if (type == "change") {
                            row2.hide();
                            row3.show();
                            row4.hide();
                        } else if (type == "delete") {
                            row2.hide();
                            row3.hide();
                            row4.hide();
                        } else if (type == "move") {
                            row2.hide();
                            row3.hide();
                            row4.show();
                        }
                        resizeRule(container);
                    });

                    selectField.val(rule.t);
                    propertyName.typedInput("value", rule.p);
                    propertyName.typedInput("type", rule.pt);
                    propertyValue.typedInput("value", rule.to);
                    propertyValue.typedInput("type", rule.tot);
                    moveValue.typedInput("value", rule.to);
                    moveValue.typedInput("type", rule.tot);
                    fromValue.typedInput("value", rule.from);
                    fromValue.typedInput("type", rule.fromt);
                    toValue.typedInput("value", rule.to);
                    toValue.typedInput("type", rule.tot);
                    selectField.change();

                    let newWidth = $("#node-input-rule-container").width();
                    resizeRule(container);
                },
                resizeItem: resizeRule,
                removable: true,
                sortable: true
            });

            for (let i = 0; i < this.rules.length; i++) {
                let rule = this.rules[i];
                $("#node-input-rule-container").editableList("addItem", rule);
            }
        },
        oneditsave: function () {
            let rules = $("#node-input-rule-container").editableList("items");
            let ruleset;
            let node = this;
            node.rules = [];
            rules.each(function (i) {
                let rule = $(this);
                let type = rule.find(".node-input-rule-type").val();
                let r = {
                    t: type,
                    p: rule.find(".node-input-rule-property-name").typedInput("value"),
                    pt: rule.find(".node-input-rule-property-name").typedInput("type")
                };
                if (type === "set") {
                    r.to = rule.find(".node-input-rule-property-value").typedInput("value");
                    r.tot = rule.find(".node-input-rule-property-value").typedInput("type");
                } else if (type === "move") {
                    r.to = rule.find(".node-input-rule-property-move-value").typedInput("value");
                    r.tot = rule.find(".node-input-rule-property-move-value").typedInput("type");
                } else if (type === "change") {
                    r.from = rule.find(".node-input-rule-property-search-value").typedInput("value");
                    r.fromt = rule.find(".node-input-rule-property-search-value").typedInput("type");
                    r.to = rule.find(".node-input-rule-property-replace-value").typedInput("value");
                    r.tot = rule.find(".node-input-rule-property-replace-value").typedInput("type");
                }
                node.rules.push(r);
            });
        },
        oneditresize: function (size) {
            let rows = $("#dialog-form>div:not(.node-input-rule-container-row)");
            let height = size.height;
            for (let i = 0; i < rows.size(); i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            let editorRow = $("#dialog-form>div.node-input-rule-container-row");
            height -= (parseInt(editorRow.css("marginTop")) + parseInt(editorRow.css("marginBottom")));

            $("#node-input-rule-container").editableList("height", height);
        }
    });
</script>